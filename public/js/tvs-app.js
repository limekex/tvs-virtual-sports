(()=>{(function(){let xe=(t,a)=>(a||document).querySelector(t),_e=t=>new URLSearchParams(location.search).get(t),W=new URLSearchParams(location.search).get("tvsdebug")==="1"||window.TVS_DEBUG===!0||localStorage.getItem("tvsDev")==="1";W||document.addEventListener("keydown",t=>{t.key==="`"&&(localStorage.setItem("tvsDev","1"),location.reload())});function h(...t){W&&console.debug("[TVS]",...t)}function w(...t){console.error("[TVS]",...t)}let te=!!(window.React&&window.ReactDOM),M=!!(window.wp&&window.wp.element)?window.wp.element:{},T=te?window.React:M||{},A=te?window.ReactDOM:M||null,J=new WeakMap,de=A&&typeof A.createRoot=="function"||M&&typeof M.createRoot=="function";function ne(t,a,o){try{let s=J.get(o);if(s&&typeof s.unmount=="function"?(s.unmount(),J.delete(o)):A&&typeof A.unmountComponentAtNode=="function"&&A.unmountComponentAtNode(o),de){let e=(A&&A.createRoot||M&&M.createRoot)(o);J.set(o,e),e.render(T.createElement(t,a));return}let f=A&&A.render||M&&M.render;if(f){f(T.createElement(t,a),o);return}w("Ingen render-funksjon tilgjengelig.")}catch(s){w("Mount feilet:",s)}}let O=Number(new URLSearchParams(location.search).get("tvsslow")||0);function Y(t){return new Promise(a=>setTimeout(a,t))}async function oe(t,a,o="operation"){let s;try{return await Promise.race([t,new Promise((f,i)=>{s=setTimeout(()=>i(new Error(o+" timed out")),a)})])}finally{clearTimeout(s)}}function ae(t){let a=Math.floor(t/60),o=Math.floor(t%60);return a+":"+(o<10?"0":"")+o}function ue({React:t,currentTime:a,duration:o}){let s=t.createElement,f=o>0?a/o*100:0;return s("div",{className:"tvs-progress"},s("div",{className:"tvs-progress__bar"},s("div",{className:"tvs-progress__fill",style:{width:Math.min(f,100)+"%"}})),s("div",{className:"tvs-progress__time"},ae(a)+" / "+ae(o)))}function me(){let t=T.createElement;return t("div",{className:"tvs-loading",role:"status","aria-live":"polite"},t("svg",{viewBox:"0 0 64 64",className:"tvs-runner","aria-hidden":"true"},t("line",{x1:4,y1:60,x2:60,y2:60,stroke:"#bbb",strokeWidth:2,className:"track"}),t("circle",{cx:26,cy:12,r:5,fill:"none",stroke:"#111",strokeWidth:2}),t("line",{x1:26,y1:17,x2:26,y2:35,stroke:"#111",strokeWidth:2}),t("line",{x1:26,y1:22,x2:40,y2:18,stroke:"#111",strokeWidth:2,className:"arm front",style:{transformOrigin:"26px 22px"}}),t("line",{x1:26,y1:22,x2:12,y2:26,stroke:"#111",strokeWidth:2,className:"arm back",style:{transformOrigin:"26px 22px"}}),t("line",{x1:26,y1:35,x2:40,y2:48,stroke:"#111",strokeWidth:2,className:"leg front",style:{transformOrigin:"26px 35px"}}),t("line",{x1:26,y1:35,x2:16,y2:54,stroke:"#111",strokeWidth:2,className:"leg back",style:{transformOrigin:"26px 35px"}})),t("div",null,t("div",{className:"tvs-skel line"}),t("div",{className:"tvs-skel line sm"}),t("div",null,t("span",{className:"tvs-skel block"}),t("span",{className:"tvs-skel block"}),t("span",{className:"tvs-skel block"}))))}function ve(t){let{useEffect:a,useRef:o,useState:s}=t,[f,i]=s(0),e=o(performance.now()),c=o(0);return a(()=>{let S,u=l=>{c.current+=1,l-e.current>=1e3&&(i(c.current),c.current=0,e.current=l),S=requestAnimationFrame(u)};return S=requestAnimationFrame(u),()=>cancelAnimationFrame(S)},[]),f}function fe({React:t,routeId:a,lastStatus:o,lastError:s,currentTime:f,duration:i}){let{useEffect:e,useRef:c,useState:S,createElement:u}=t,l=ve(t),b=c(null),[m,d]=S(!1),[y,C]=S({x:16,y:16});e(()=>{if(!b.current)return;let _,E,g,B,V=!1;function F(N){N.target.closest(".tvs-dev__header")&&(V=!0,_=N.clientX,E=N.clientY,g=y.x,B=y.y,N.preventDefault())}function G(N){V&&C({x:g+(N.clientX-_),y:B+(N.clientY-E)})}function I(){V=!1}return window.addEventListener("mousedown",F),window.addEventListener("mousemove",G),window.addEventListener("mouseup",I),()=>{window.removeEventListener("mousedown",F),window.removeEventListener("mousemove",G),window.removeEventListener("mouseup",I)}},[y]);let j=i>0?(f/i*100).toFixed(1):"0.0",p={env:window.TVS_SETTINGS?.env,version:window.TVS_SETTINGS?.version,restRoot:window.TVS_SETTINGS?.restRoot,user:window.TVS_SETTINGS?.user,routeId:a,lastStatus:o||"idle",lastError:s?String(s):null,currentTime:f?f.toFixed(1):"0.0",duration:i||0,progress:j+"%",fps:l};function U(){navigator.clipboard.writeText(JSON.stringify({...p,time:new Date().toISOString()},null,2)).catch(console.error)}return u("div",{ref:b,className:`tvs-dev ${m?"is-min":""}`,style:{left:y.x+"px",top:y.y+"px"}},u("div",{className:"tvs-dev__header"},u("strong",null,"TVS Dev"),u("div",{className:"tvs-dev__spacer"}),u("span",{className:"tvs-dev__pill"},p.env||"n/a"),u("button",{className:"tvs-dev__btn",onClick:()=>d(!m),"aria-label":"Minimize"},"\u2581")),u("div",{className:"tvs-dev__body"},x("Route",p.routeId??"n/a"),x("User",p.user??"guest"),x("REST",p.restRoot??"n/a"),x("Status",p.lastStatus),p.lastError?x("Error",p.lastError,!0):null,x("Duration",p.duration+"s"),x("Current",p.currentTime+"s"),x("Progress",p.progress),x("FPS",String(p.fps)),u("div",{className:"tvs-dev__actions"},u("button",{onClick:U,className:"tvs-dev__btn"},"Copy debug"),u("button",{onClick:()=>{localStorage.setItem("tvsDev","0"),location.reload()},className:"tvs-dev__btn tvs-dev__btn--ghost"},"Disable"))));function x(L,_,E){return t.createElement("div",{className:"tvs-dev__row"},t.createElement("span",null,L),t.createElement("code",{className:E?"tvs-dev__err":""},_))}}function ye({initialData:t,routeId:a}){let{useEffect:o,useState:s,useRef:f,createElement:i}=T,[e,c]=s(t||null),[S,u]=s(null),[l,b]=s(!1),[m,d]=s(!1),[y,C]=s(null),[j,p]=s([]),[U,x]=s(!1),[L,_]=s(null),[E,g]=s(t?"inline":"loading"),[B,V]=s(null),[F,G]=s(0),[I,N]=s(!1),K=f(null),Q=f(null);function P(r,n="success"){window.tvsFlash(r,n)}o(()=>{let r=new URLSearchParams(location.search).get("tvsforcefetch")==="1";if(e&&!r){h("Har inline payload, skipper fetch.",e);return}if(!a){u("Mangler routeId \u2013 hverken inline payload eller data-route-id.");return}(async()=>{try{h("Henter rute via REST:",a," (tvsslow:",O,"ms)"),g("loading"),O&&await Y(O);let v=await(await fetch(`/wp-json/tvs/v1/routes/${encodeURIComponent(a)}`,{credentials:"same-origin"})).json();h("REST OK:",v),c(v),g("ok")}catch(n){w("REST FAIL:",n),u("Kunne ikke hente rutedata."),V(n?.message||String(n)),g("error")}})()},[a]),o(()=>{Z()},[]);async function Z(){try{x(!0);let n=await fetch("/wp-json/tvs/v1/activities/me",{credentials:"same-origin",headers:{"X-TVS-Nonce":window.TVS_SETTINGS?.nonce||""}});if(!n.ok)throw new Error("Failed to load activities");let v=await n.json(),D=Array.isArray(v)?v:v.activities||[];p(D)}catch(r){w("Load activities FAIL:",r),p([])}finally{x(!1)}}o(()=>{if(!e)return;let r=K.current;if(!r)return;let n=null,v=!1;function D(){return new Promise((k,H)=>{if(window.Vimeo&&window.Vimeo.Player)return k();let z=document.querySelector('script[src="https://player.vimeo.com/api/player.js"]');if(z){z.addEventListener("load",()=>k()),z.addEventListener("error",()=>H(new Error("Vimeo API failed to load")));return}let R=document.createElement("script");R.src="https://player.vimeo.com/api/player.js",R.async=!0,R.onload=()=>k(),R.onerror=()=>H(new Error("Vimeo API failed to load")),document.head.appendChild(R)})}return(async()=>{try{if(await D(),v)return;n=new window.Vimeo.Player(r),Q.current=n,h("Vimeo Player constructed"),n.getDuration().then(k=>{!Number(e?.meta?.duration_s)&&typeof k=="number"&&k>0}).catch(()=>{});try{await n.ready(),v||(N(!0),h("Vimeo Player ready"))}catch(k){w("Vimeo ready() rejected:",k)}n.on("timeupdate",k=>{typeof k?.seconds=="number"&&G(k.seconds)})}catch{w("Vimeo API init failed")}})(),()=>{v=!0;try{n&&n.off&&n.off("timeupdate"),n&&n.destroy&&n.destroy()}catch{}Q.current=null,N(!1)}},[e]);async function X(r=8e3){let n=Date.now();for(;Date.now()-n<r;){let v=Q.current;if(v)try{return await v.ready(),N(!0),v}catch{}await Y(100)}throw new Error("Video player is not ready")}function we(r){let n=e?.meta||{},v=Number(n.duration_s||0),D=Number(n.distance_m||0);if(v>0&&D>0&&r>=0){let k=Math.min(1,r/v);return Math.round(D*k)}return 0}async function se(){try{b(!0),h("Start clicked");let r=await X();g("starting");try{await oe(r.play(),4e3,"play()"),h("Playback started")}catch(n){throw w("play() failed:",n),P("Could not start playback: "+(n?.message||String(n)),"error"),n}try{await oe(r.setCurrentTime(0),2e3,"setCurrentTime(0)"),h("Seeked to 0")}catch(n){w("setCurrentTime(0) failed (continuing):",n)}C(new Date),d(!0),g("running")}catch(r){w("Start session failed:",r),P("Player not ready yet. Please wait a moment and try again.","error"),g("error")}finally{b(!1)}}async function he(){try{b(!0),h("Resume clicked");let r=await X();g("starting");try{await r.play(),h("Playback resumed")}catch(n){throw w("resume play() failed:",n),P("Could not resume playback: "+(n?.message||String(n)),"error"),n}d(!0),g("running")}catch(r){w("Resume session failed:",r),P("Player not ready yet. Please wait a moment and try again.","error"),g("error")}finally{b(!1)}}async function Se(){try{h("Pause clicked");let r=await X();try{await r.pause(),h("Playback paused")}catch(n){throw w("pause() failed:",n),P("Failed to pause: "+(n?.message||String(n)),"error"),n}d(!1),g("paused")}catch(r){w("[TVS] Pause failed:",r),g("error")}}async function le(){try{b(!0),h("Finish clicked");let r=await X();g("saving");try{await r.pause(),h("Playback paused before save")}catch(ee){w("pause before save failed:",ee)}let n=await r.getCurrentTime(),v=Math.max(0,Math.floor(n||0)),D=y?y.toISOString():new Date(Date.now()-v*1e3).toISOString(),k=we(v),H={route_id:e.id,route_name:e.title||"Unknown Route",activity_date:new Date().toISOString(),started_at:D,duration_s:v,distance_m:k},z=window.TVS_SETTINGS?.nonce||"";O&&await Y(O);let R=await fetch("/wp-json/tvs/v1/activities",{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":z},credentials:"same-origin",body:JSON.stringify(H)});if(!R.ok){let ee=await R.json();throw new Error(ee.message||`HTTP ${R.status}`)}let Te=await R.json();P("Activity saved!"),g("ok"),d(!1),C(null),await Z(),window.dispatchEvent(new CustomEvent("tvs:activity-updated"))}catch(r){w("[TVS] Save activity failed:",r),P("Failed to save activity: "+(r?.message||String(r)),"error"),V(r?.message||String(r)),g("error")}finally{b(!1)}}async function Ne(r){try{_(r),g("uploading");let n=await fetch(`/wp-json/tvs/v1/activities/${r}/strava`,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":window.TVS_SETTINGS?.nonce||""},credentials:"same-origin"}),v=await n.json();if(!n.ok)throw new Error(v.message||"Upload failed");P("Uploaded to Strava!"),g("ok"),await Z(),window.dispatchEvent(new CustomEvent("tvs:activity-updated"))}catch(n){w("Strava upload FAIL:",n),P("Failed to upload to Strava: "+(n?.message||String(n)),"error"),V(n?.message||String(n)),g("error")}finally{_(null)}}if(S)return i("div",{className:"tvs-route tvs-error"},String(S));if(!e)return T.createElement(me,null);let be=e.title||"Route",$=e.meta||{},ce=$.vimeo_id?String($.vimeo_id):"",q=Number($.duration_s||0),ke=!!window.TVS_SETTINGS?.user;return i("div",{className:"tvs-app"},i("h2",null,be),ce?i("div",{className:"tvs-video"},i("iframe",{ref:K,width:560,height:315,src:"https://player.vimeo.com/video/"+encodeURIComponent(ce)+"?controls=0&title=0&byline=0&portrait=0&pip=0&playsinline=1&dnt=1&transparent=0&muted=0",frameBorder:0,allow:"autoplay; fullscreen; picture-in-picture",allowFullScreen:!0})):null,new URLSearchParams(location.search).get("tvsdebug")==="1"||window.TVS_DEBUG===!0||localStorage.getItem("tvsDev")==="1"?i("div",{className:"tvs-meta"},i("pre",null,JSON.stringify($,null,2))):null,i(ue,{React:T,currentTime:F,duration:q}),i("div",{style:{display:"flex",gap:"8px",flexWrap:"wrap"}},ke?m?[i("button",{key:"pause",className:"tvs-btn",onClick:Se,disabled:l||!I,style:{backgroundColor:"#f59e0b"}},"Pause"),i("button",{key:"finish",className:"tvs-btn",onClick:le,disabled:l||!I,style:{backgroundColor:"#10b981"}},l?i("span",{className:"tvs-spinner","aria-hidden":"true"}):null,l?" Saving...":"Finish & Save")]:F>0&&y&&(q===0||F<q-.5)?[i("button",{key:"resume",className:"tvs-btn",onClick:he,disabled:l||!I},l?i("span",{className:"tvs-spinner","aria-hidden":"true"}):null,l?" Starting...":"Resume Activity"),i("button",{key:"finish",className:"tvs-btn",onClick:le,disabled:l||!I,style:{backgroundColor:"#10b981"}},l?i("span",{className:"tvs-spinner","aria-hidden":"true"}):null,l?" Saving...":"Finish & Save"),i("button",{key:"restart",className:"tvs-btn",onClick:se,disabled:l||!I,style:{backgroundColor:"#334155"}},"Restart from 0:00")]:i("button",{className:"tvs-btn",onClick:se,disabled:l||!I},l?i("span",{className:"tvs-spinner","aria-hidden":"true"}):null,l?" Starting...":"Start Activity"):i("div",{style:{backgroundColor:"#fef3c7",border:"1px solid #f59e0b",padding:"1rem",margin:"0.5rem 0 0 0",borderRadius:"4px",width:"100%"}},i("strong",null,"\u26A0\uFE0F You must be logged in"),i("p",{style:{margin:"0.5rem 0 0 0"}},"Please ",i("a",{href:"/login",style:{color:"#1f2937",textDecoration:"underline"}},"log in")," to create activities and upload to Strava. Don't have an account? ",i("a",{href:"/register",style:{color:"#1f2937",textDecoration:"underline"}},"Register here"),"."))),W?i(fe,{React:T,routeId:a,lastStatus:E,lastError:B,currentTime:F,duration:q}):null)}function pe({React:t,activities:a,loadingActivities:o,uploadToStrava:s,uploadingId:f}){let{useState:i,createElement:e}=t,[c,S]=i(!1),u=a.slice(0,5);return e("div",{className:"tvs-activities-block",style:{marginTop:"1rem",border:"1px solid #e5e7eb",borderRadius:"8px",background:"#fff",padding:"1rem"}},e("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:"1rem"}},e("h3",{style:{margin:0,fontSize:"1.25rem"}},"Recent Activities"),e("button",{onClick:()=>S(!c),style:{fontSize:"1.2em",background:"none",border:"none",cursor:"pointer",color:"#666"},"aria-label":c?"Expand":"Minimize"},c?"\u25B8":"\u25BE")),c?null:o?e("p",{style:{color:"#666"}},"Loading activities..."):u.length===0?e("p",{style:{color:"#666"}},"Start a new activity when you're ready"):e("div",null,e("div",{className:"tvs-activities-list",style:{marginBottom:"1rem"}},u.map(l=>e(ie,{key:l.id,activity:l,uploadToStrava:s,uploading:f===l.id,React:t,compact:!0}))),e("div",{style:{textAlign:"center",paddingTop:"0.5rem",borderTop:"1px solid #e5e7eb"}},e("a",{href:"/my-activities",style:{color:"#2563eb",textDecoration:"none",fontSize:"0.9rem"}},"Go to my activities \u2192"))))}function ie({activity:t,uploadToStrava:a,uploading:o,React:s,compact:f,dummy:i}){let{createElement:e}=s,c=t.meta||{},S=t.id,u=c._tvs_synced_strava?.[0]||c.synced_strava?.[0],l=c._tvs_strava_remote_id?.[0]||c.strava_activity_id?.[0],b=u==="1"||u===1,m=c._tvs_distance_m?.[0]||c.distance_m?.[0]||0,d=c._tvs_duration_s?.[0]||c.duration_s?.[0]||0,y=c._tvs_route_id?.[0]||c.route_id?.[0],C=c._tvs_route_name?.[0]||c.route_name?.[0]||"Unknown Route",j=c._tvs_activity_date?.[0]||c.activity_date?.[0]||t.date||"",p="";if(j)try{p=new Date(j).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"})}catch{p=j}let U=p?`${C} (${p})`:C;if(f){let{useState:x}=s,[L,_]=x(!1);return i?e("div",{className:"tvs-activity-card-compact",style:{padding:"0.75rem",marginBottom:"0.5rem",borderRadius:"4px",background:"linear-gradient(90deg, #f3f4f6 60%, #e5e7eb 100%)",fontSize:"0.9rem",position:"relative",opacity:.6,filter:"grayscale(0.7)",pointerEvents:"none"}},e("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",gap:"0.5rem"}},e("div",{style:{flex:1,minWidth:0}},e("div",{style:{fontWeight:"500",marginBottom:"0.25rem"}},U),e("div",{style:{fontSize:"0.85rem",color:"#888"}},m>0?(m/1e3).toFixed(2)+" km":"",m>0&&d>0?" \xB7 ":"",d>0?Math.floor(d/60)+" min":"")),e("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",flexShrink:0}},e("span",{style:{color:"#bbb",fontSize:"1.5rem",lineHeight:1,display:"flex",alignItems:"center"},title:"Preview"},"\u2713"),e("div",{style:{width:"32px",height:"32px",borderRadius:"4px",backgroundColor:"#e5e7eb",color:"#ccc",display:"flex",alignItems:"center",justifyContent:"center",fontWeight:"bold"}},"S")))):e("div",{className:"tvs-activity-card-compact",style:{padding:"0.75rem",marginBottom:"0.5rem",borderRadius:"4px",backgroundColor:"#f9fafb",fontSize:"0.9rem",position:"relative"}},e("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",gap:"0.5rem"}},e("div",{style:{flex:1,minWidth:0}},e("div",{style:{fontWeight:"500",marginBottom:"0.25rem"}},U),e("div",{style:{fontSize:"0.85rem",color:"#666"}},m>0?(m/1e3).toFixed(2)+" km":"",m>0&&d>0?" \xB7 ":"",d>0?Math.floor(d/60)+" min":"")),e("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",flexShrink:0}},b?e("span",{style:{color:"#10b981",fontSize:"1.5rem",lineHeight:1,display:"flex",alignItems:"center"},title:"Synced to Strava"},"\u2713"):null,e("div",{style:{position:"relative"}},b?e("a",{href:l?"https://www.strava.com/activities/"+l:"#",target:"_blank",rel:"noopener noreferrer",title:"View on Strava",style:{display:"flex",alignItems:"center",justifyContent:"center",width:"32px",height:"32px",borderRadius:"4px",backgroundColor:"#fc4c02",color:"white",textDecoration:"none",fontSize:"0.9rem",fontWeight:"bold"}},"S"):e("button",{onClick:E=>{E.stopPropagation(),_(!L)},disabled:o,title:"Upload to Strava",style:{display:"flex",alignItems:"center",justifyContent:"center",width:"32px",height:"32px",borderRadius:"4px",backgroundColor:o?"#ccc":"#fc4c02",color:"white",border:"none",cursor:o?"wait":"pointer",fontSize:"0.9rem",fontWeight:"bold"}},o?"...":"S"),L&&!b&&!o?e("div",{style:{position:"absolute",right:0,top:"calc(100% + 0.5rem)",backgroundColor:"white",border:"1px solid #e5e7eb",borderRadius:"8px",padding:"0.75rem",boxShadow:"0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06)",zIndex:1e3,minWidth:"200px",whiteSpace:"nowrap"}},e("div",{style:{fontSize:"0.9rem",marginBottom:"0.5rem",color:"#374151"}},"Upload to Strava?"),e("div",{style:{display:"flex",gap:"0.5rem"}},e("button",{onClick:E=>{E.stopPropagation(),_(!1),a(S)},style:{flex:1,padding:"0.5rem 0.75rem",backgroundColor:"#fc4c02",color:"white",border:"none",borderRadius:"4px",cursor:"pointer",fontSize:"0.85rem",fontWeight:"500"}},"Upload"),e("button",{onClick:E=>{E.stopPropagation(),_(!1)},style:{flex:1,padding:"0.5rem 0.75rem",backgroundColor:"#f3f4f6",color:"#374151",border:"none",borderRadius:"4px",cursor:"pointer",fontSize:"0.85rem"}},"Cancel"))):null))),L?e("div",{style:{position:"fixed",inset:0,zIndex:999},onClick:()=>_(!1)}):null)}return e("div",{className:"tvs-activity-card",style:{border:"1px solid #ddd",padding:"1rem",marginBottom:"1rem",borderRadius:"4px",backgroundColor:b?"#f0f9ff":"#fff"}},e("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"}},e("div",null,e("strong",null,U),e("div",{style:{marginTop:"0.5rem",fontSize:"0.9rem",color:"#666"}},m>0?e("span",null,"Distance: "+(m/1e3).toFixed(2)+" km "):null,d>0?e("span",null,"Duration: "+Math.floor(d/60)+" min"):null)),e("div",null,b?e("div",{style:{textAlign:"right"}},e("span",{style:{color:"#10b981",fontWeight:"bold"}},"\u2713 Synced to Strava"),l?e("a",{href:"https://www.strava.com/activities/"+l,target:"_blank",rel:"noopener noreferrer",style:{display:"block",marginTop:"0.25rem",fontSize:"0.85rem"}},"View on Strava \u2192"):null):e("button",{className:"tvs-btn tvs-btn-strava",onClick:()=>a(S),disabled:o,style:{backgroundColor:"#fc4c02",color:"white",border:"none",padding:"0.5rem 1rem",borderRadius:"4px",cursor:o?"wait":"pointer",opacity:o?.6:1}},o?"Uploading...":"Upload to Strava"))))}function re(){let t=document.getElementById("tvs-app-root");if(t){let a=window.tvs_route_payload||null,o=t.getAttribute("data-route-id")||a&&a.id;h("Boot \u2192 routeId:",o,"inline payload:",!!a),ne(ye,{initialData:a,routeId:o},t)}window.tvsMyActivitiesMount&&Array.isArray(window.tvsMyActivitiesMount)&&window.tvsMyActivitiesMount.forEach(a=>{let o=document.getElementById(a);o&&(h("Mounting MyActivities block on:",a),ne(ge,{},o))})}function ge(){let{useState:t,useEffect:a,createElement:o}=T,[s,f]=t([]),[i,e]=t(!1),[c,S]=t(null),u=!!window.TVS_SETTINGS?.user;a(()=>{if(!u)return;l();let m=()=>{W&&console.info("[TVS] MyActivitiesStandalone: Received activity update event, reloading..."),l()};return window.addEventListener("tvs:activity-updated",m),()=>{window.removeEventListener("tvs:activity-updated",m)}},[]);async function l(){try{e(!0);let d=await fetch("/wp-json/tvs/v1/activities/me",{credentials:"same-origin",headers:{"X-TVS-Nonce":window.TVS_SETTINGS?.nonce||""}});if(!d.ok)throw new Error("Failed to load activities");let y=await d.json(),C=Array.isArray(y)?y:y.activities||[];f(C)}catch(m){w("Load activities FAIL:",m),f([])}finally{e(!1)}}async function b(m){try{S(m);let d=await fetch(`/wp-json/tvs/v1/activities/${m}/strava`,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":window.TVS_SETTINGS?.nonce||""},credentials:"same-origin"}),y=await d.json();if(!d.ok)throw new Error(y.message||"Upload failed");window.tvsFlash("Uploaded to Strava!"),await l(),window.dispatchEvent(new CustomEvent("tvs:activity-updated"))}catch(d){w("Strava upload FAIL:",d),window.tvsFlash("Failed to upload to Strava: "+(d?.message||String(d)),"error")}finally{S(null)}}if(!u){let m=Array.from({length:3}).map((d,y)=>({id:"dummy-"+y,meta:{_tvs_route_name:["Sample Route "+(y+1)],_tvs_activity_date:[new Date(Date.now()-y*864e5).toISOString()],_tvs_distance_m:[Math.round(5e3+Math.random()*5e3)],_tvs_duration_s:[Math.round(1200+Math.random()*1800)]}}));return o("div",{className:"tvs-activities-block",style:{marginTop:"1rem",border:"1px solid #e5e7eb",borderRadius:"8px",background:"#fff",padding:"1rem"}},o("h3",{style:{marginTop:0}},"My Activities"),o("div",{className:"tvs-activities-list",style:{marginBottom:"1rem"}},m.map(d=>o(ie,{key:d.id,activity:d,React:T,compact:!0,dummy:!0}))),o("div",{style:{textAlign:"center",color:"#888",fontSize:"0.95rem",marginBottom:"0.5rem"}},"Sign in to see your recent activities."),o("div",{style:{textAlign:"center"}},o("a",{href:"/login",style:{color:"#1f2937",textDecoration:"underline",marginRight:12}},"Log in"),o("a",{href:"/register",style:{color:"#1f2937",textDecoration:"underline"}},"Register")))}return o(pe,{React:T,activities:s,loadingActivities:i,uploadToStrava:b,uploadingId:c})}W?h("Debug mode enabled."):document.addEventListener("keydown",function(t){if(t.key==="`"){let a=new URL(location.href);a.searchParams.set("tvsdebug","1"),location.href=a.toString()}}),document.readyState==="loading"?document.addEventListener("DOMContentLoaded",re):re()})();})();
//# sourceMappingURL=tvs-app.js.map
