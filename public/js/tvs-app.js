(()=>{var U=new URLSearchParams(location.search).get("tvsdebug")==="1"||window.TVS_DEBUG===!0||localStorage.getItem("tvsDev")==="1";function l(...t){U&&console.debug("[TVS]",...t)}function m(...t){console.error("[TVS]",...t)}var le=!!(window.React&&window.ReactDOM),we=!!(window.wp&&window.wp.element),D=we?window.wp.element:{},T=le?window.React:D||{},_=le?window.ReactDOM:D||null,Z=new WeakMap,ge=_&&typeof _.createRoot=="function"||D&&typeof D.createRoot=="function";function de(t,o,c){try{let s=Z.get(c);if(s&&typeof s.unmount=="function"?(s.unmount(),Z.delete(c)):_&&typeof _.unmountComponentAtNode=="function"&&_.unmountComponentAtNode(c),ge){let u=(_&&_.createRoot||D&&D.createRoot)(c);Z.set(c,u),u.render(T.createElement(t,o));return}let g=_&&_.render||D&&D.render;if(g){g(T.createElement(t,o),c);return}m("Ingen render-funksjon tilgjengelig.")}catch(s){m("Mount feilet:",s)}}function W(t){return new Promise(o=>setTimeout(o,t))}async function K(t,o,c="operation"){let s;try{return await Promise.race([t,new Promise((g,a)=>{s=setTimeout(()=>a(new Error(c+" timed out")),o)})])}finally{clearTimeout(s)}}function ee({React:t,currentTime:o,duration:c}){let s=t.createElement,g=Math.floor(o/60),a=Math.floor(o%60),u=(I,d)=>I+":"+(d<10?"0":"")+d,j=c>0?o/c*100:0;return s("div",{className:"tvs-progress"},s("div",{className:"tvs-progress__bar"},s("div",{className:"tvs-progress__fill",style:{width:Math.min(j,100)+"%"}})),s("div",{className:"tvs-progress__time"},u(g,a)+" / "+u(Math.floor(c/60),Math.floor(c%60))))}function te(){let t=T.createElement;return t("div",{className:"tvs-loading",role:"status","aria-live":"polite"},t("svg",{viewBox:"0 0 64 64",className:"tvs-runner","aria-hidden":"true"},t("line",{x1:4,y1:60,x2:60,y2:60,stroke:"#bbb",strokeWidth:2,className:"track"}),t("circle",{cx:26,cy:12,r:5,fill:"none",stroke:"#111",strokeWidth:2}),t("line",{x1:26,y1:17,x2:26,y2:35,stroke:"#111",strokeWidth:2}),t("line",{x1:26,y1:22,x2:40,y2:18,stroke:"#111",strokeWidth:2,className:"arm front"}),t("line",{x1:26,y1:22,x2:12,y2:26,stroke:"#111",strokeWidth:2,className:"arm back"}),t("line",{x1:26,y1:35,x2:40,y2:48,stroke:"#111",strokeWidth:2,className:"leg front"}),t("line",{x1:26,y1:35,x2:16,y2:54,stroke:"#111",strokeWidth:2,className:"leg back"})),t("div",null,t("div",{className:"tvs-skel line"}),t("div",{className:"tvs-skel line sm"}),t("div",null,t("span",{className:"tvs-skel block"}),t("span",{className:"tvs-skel block"}),t("span",{className:"tvs-skel block"}))))}function ne({React:t,routeId:o,lastStatus:c,lastError:s,currentTime:g,duration:a}){let{useEffect:u,useRef:j,useState:I,createElement:d}=t;function v(L){let{useEffect:x,useRef:r,useState:M}=L,[A,b]=M(0),V=r(performance.now()),y=r(0);return x(()=>{let k,w=F=>{y.current+=1,F-V.current>=1e3&&(b(y.current),y.current=0,V.current=F),k=requestAnimationFrame(w)};return k=requestAnimationFrame(w),()=>cancelAnimationFrame(k)},[]),A}let R=v(t),X=j(null),[C,O]=I(!1),[P,se]=I({x:16,y:16});u(()=>{if(!X.current)return;let x,r,M,A,b=!1;function V(w){w.target.closest(".tvs-dev__header")&&(b=!0,x=w.clientX,r=w.clientY,M=P.x,A=P.y,w.preventDefault())}function y(w){b&&se({x:M+(w.clientX-x),y:A+(w.clientY-r)})}function k(){b=!1}return window.addEventListener("mousedown",V),window.addEventListener("mousemove",y),window.addEventListener("mouseup",k),()=>{window.removeEventListener("mousedown",V),window.removeEventListener("mousemove",y),window.removeEventListener("mouseup",k)}},[P]);let $=a>0?(g/a*100).toFixed(1):"0.0",p={env:window.TVS_SETTINGS?.env,version:window.TVS_SETTINGS?.version,restRoot:window.TVS_SETTINGS?.restRoot,user:window.TVS_SETTINGS?.user,routeId:o,lastStatus:c||"idle",lastError:s?String(s):null,currentTime:g?g.toFixed(1):"0.0",duration:a||0,progress:$+"%",fps:R};function h(L,x,r){return d("div",{className:"tvs-dev__row"},d("span",null,L),d("code",{className:r?"tvs-dev__err":""},x))}function oe(){navigator.clipboard.writeText(JSON.stringify({...p,time:new Date().toISOString()},null,2)).catch(console.error)}return d("div",{ref:X,className:`tvs-dev ${C?"is-min":""}`,style:{left:P.x+"px",top:P.y+"px"}},d("div",{className:"tvs-dev__header"},d("strong",null,"TVS Dev"),d("div",{className:"tvs-dev__spacer"}),d("span",{className:"tvs-dev__pill"},p.env||"n/a"),d("button",{className:"tvs-dev__btn",onClick:()=>O(!C),"aria-label":"Minimize"},"\u2581")),d("div",{className:"tvs-dev__body"},h("Route",p.routeId??"n/a"),h("User",p.user??"guest"),h("REST",p.restRoot??"n/a"),h("Status",p.lastStatus),p.lastError?h("Error",p.lastError,!0):null,h("Duration",p.duration+"s"),h("Current",p.currentTime+"s"),h("Progress",p.progress),h("FPS",String(p.fps)),d("div",{className:"tvs-dev__actions"},d("button",{onClick:oe,className:"tvs-dev__btn"},"Copy debug"),d("button",{onClick:()=>{localStorage.setItem("tvsDev","0"),location.reload()},className:"tvs-dev__btn tvs-dev__btn--ghost"},"Disable"))))}var B=Number(new URLSearchParams(location.search).get("tvsslow")||0);function ae({initialData:t,routeId:o}){let{useEffect:c,useState:s,useRef:g,createElement:a}=T,[u,j]=s(t||null),[I,d]=s(null),[v,R]=s(!1),[X,C]=s(!1),[O,P]=s(null),[se,$]=s([]),[p,h]=s(!1),[oe,L]=s(null),[x,r]=s(t?"inline":"loading"),[M,A]=s(null),[b,V]=s(0),[y,k]=s(!1),w=g(null),F=g(null);function S(n,e="success"){typeof window.tvsFlash=="function"&&window.tvsFlash(n,e)}c(()=>{let n=new URLSearchParams(location.search).get("tvsforcefetch")==="1";if(u&&!n){l("Har inline payload, skipper fetch.",u);return}if(!o){d("Mangler routeId \u2013 hverken inline payload eller data-route-id.");return}(async()=>{try{l("Henter rute via REST:",o," (tvsslow:",B,"ms)"),r("loading"),B&&await W(B);let i=await(await fetch(`/wp-json/tvs/v1/routes/${encodeURIComponent(o)}`,{credentials:"same-origin"})).json();l("REST OK:",i),j(i),r("ok")}catch(e){m("REST FAIL:",e),d("Kunne ikke hente rutedata."),A(e?.message||String(e)),r("error")}})()},[o]),c(()=>{z()},[]);async function z(){try{h(!0);let e=await fetch("/wp-json/tvs/v1/activities/me",{credentials:"same-origin",headers:{"X-TVS-Nonce":window.TVS_SETTINGS?.nonce||""}});if(!e.ok)throw new Error("Failed to load activities");let i=await e.json(),E=Array.isArray(i)?i:i.activities||[];$(E)}catch(n){m("Load activities FAIL:",n),$([])}finally{h(!1)}}c(()=>{if(!u)return;let n=w.current;if(!n)return;let e=null,i=!1;function E(){return new Promise((f,Y)=>{if(window.Vimeo&&window.Vimeo.Player)return f();let G=document.querySelector('script[src="https://player.vimeo.com/api/player.js"]');if(G){G.addEventListener("load",()=>f()),G.addEventListener("error",()=>Y(new Error("Vimeo API failed to load")));return}let N=document.createElement("script");N.src="https://player.vimeo.com/api/player.js",N.async=!0,N.onload=()=>f(),N.onerror=()=>Y(new Error("Vimeo API failed to load")),document.head.appendChild(N)})}return(async()=>{try{if(await E(),i)return;e=new window.Vimeo.Player(n),F.current=e,l("Vimeo Player constructed"),e.getDuration().catch(()=>{});try{await e.ready(),i||(k(!0),l("Vimeo Player ready"))}catch(f){m("Vimeo ready() rejected:",f)}e.on("timeupdate",f=>{typeof f?.seconds=="number"&&V(f.seconds)})}catch{m("Vimeo API init failed")}})(),()=>{i=!0;try{e&&e.off&&e.off("timeupdate"),e&&e.destroy&&e.destroy()}catch{}F.current=null,k(!1)}},[u]);async function q(n=8e3){let e=Date.now();for(;Date.now()-e<n;){let i=F.current;if(i)try{return await i.ready(),k(!0),i}catch{}await W(100)}throw new Error("Video player is not ready")}function me(n){let e=u?.meta||{},i=Number(e.duration_s||0),E=Number(e.distance_m||0);if(i>0&&E>0&&n>=0){let f=Math.min(1,n/i);return Math.round(E*f)}return 0}async function re(){try{R(!0),l("Start clicked");let n=await q();r("starting");try{await K(n.play(),4e3,"play()"),l("Playback started")}catch(e){throw m("play() failed:",e),S("Could not start playback: "+(e?.message||String(e)),"error"),e}try{let e=await K(n.getCurrentTime(),1500,"getCurrentTime");typeof e=="number"&&e>.5?(await W(150),await K(n.setCurrentTime(0),2e3,"setCurrentTime(0)"),l("Seeked to 0")):l("Already at start, skipping seek")}catch(e){l("Post-play seek skipped:",e?.message||String(e))}P(new Date),C(!0),r("running"),S("Activity started")}catch(n){m("Start session failed:",n),S("Player not ready yet. Please wait a moment and try again.","error"),r("error")}finally{R(!1)}}async function ve(){try{R(!0),l("Resume clicked");let n=await q();r("starting");try{await n.play(),l("Playback resumed")}catch(e){throw m("resume play() failed:",e),S("Could not resume playback: "+(e?.message||String(e)),"error"),e}C(!0),r("running"),S("Activity resumed")}catch(n){m("Resume session failed:",n),S("Player not ready yet. Please wait a moment and try again.","error"),r("error")}finally{R(!1)}}async function fe(){try{l("Pause clicked");let n=await q();try{await n.pause(),l("Playback paused")}catch(e){throw m("pause() failed:",e),S("Failed to pause: "+(e?.message||String(e)),"error"),e}C(!1),r("paused"),S("Activity paused")}catch(n){m("[TVS] Pause failed:",n),r("error")}}async function ie(){try{R(!0),l("Finish clicked");let n=await q();r("saving");try{await n.pause(),l("Playback paused before save")}catch(Q){m("pause before save failed:",Q)}let e=await n.getCurrentTime(),i=Math.max(0,Math.floor(e||0)),E=O?O.toISOString():new Date(Date.now()-i*1e3).toISOString(),f=me(i),Y={route_id:u.id,route_name:u.title||"Unknown Route",activity_date:new Date().toISOString(),started_at:E,duration_s:i,distance_m:f},G=window.TVS_SETTINGS?.nonce||"";B&&await W(B);let N=await fetch("/wp-json/tvs/v1/activities",{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":G},credentials:"same-origin",body:JSON.stringify(Y)});if(!N.ok){let Q=await N.json();throw new Error(Q.message||`HTTP ${N.status}`)}await N.json(),S("Activity saved!"),r("ok"),C(!1),P(null),await z(),window.dispatchEvent(new CustomEvent("tvs:activity-updated"))}catch(n){m("[TVS] Save activity failed:",n),S("Failed to save activity: "+(n?.message||String(n)),"error"),A(n?.message||String(n)),r("error")}finally{R(!1)}}async function he(n){try{L(n),r("uploading");let e=await fetch(`/wp-json/tvs/v1/activities/${n}/strava`,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":window.TVS_SETTINGS?.nonce||""},credentials:"same-origin"}),i=await e.json();if(!e.ok)throw new Error(i.message||"Upload failed");S("Uploaded to Strava!"),r("ok"),await z(),window.dispatchEvent(new CustomEvent("tvs:activity-updated"))}catch(e){m("Strava upload FAIL:",e),S("Failed to upload to Strava: "+(e?.message||String(e)),"error"),A(e?.message||String(e)),r("error")}finally{L(null)}}if(I)return a("div",{className:"tvs-route tvs-error"},String(I));if(!u)return T.createElement(te,null);let pe=u.title||"Route",H=u.meta||{},ce=H.vimeo_id?String(H.vimeo_id):"",J=Number(H.duration_s||0),ye=!!window.TVS_SETTINGS?.user;return a("div",{className:"tvs-app"},a("h2",null,pe),ce?a("div",{className:"tvs-video"},a("iframe",{ref:w,width:560,height:315,src:"https://player.vimeo.com/video/"+encodeURIComponent(ce)+"?controls=0&title=0&byline=0&portrait=0&pip=0&playsinline=1&dnt=1&transparent=0&muted=0",frameBorder:0,allow:"autoplay; fullscreen; picture-in-picture",allowFullScreen:!0})):null,new URLSearchParams(location.search).get("tvsdebug")==="1"||window.TVS_DEBUG===!0||localStorage.getItem("tvsDev")==="1"?a("div",{className:"tvs-meta"},a("pre",null,JSON.stringify(H,null,2))):null,a(ee,{React:T,currentTime:b,duration:J}),a("div",{className:"tvs-btns"},ye?X?[a("button",{key:"pause",className:"tvs-btn tvs-btn--warning",onClick:fe,disabled:v||!y},"Pause"),a("button",{key:"finish",className:"tvs-btn tvs-btn--success",onClick:ie,disabled:v||!y},v?a("span",{className:"tvs-spinner","aria-hidden":"true"}):null,v?" Saving...":"Finish & Save")]:b>0&&O&&(J===0||b<J-.5)?[a("button",{key:"resume",className:"tvs-btn",onClick:ve,disabled:v||!y},v?a("span",{className:"tvs-spinner","aria-hidden":"true"}):null,v?" Starting...":"Resume Activity"),a("button",{key:"finish",className:"tvs-btn tvs-btn--success",onClick:ie,disabled:v||!y},v?a("span",{className:"tvs-spinner","aria-hidden":"true"}):null,v?" Saving...":"Finish & Save"),a("button",{key:"restart",className:"tvs-btn tvs-btn--muted",onClick:re,disabled:v||!y},"Restart from 0:00")]:a("button",{className:"tvs-btn",onClick:re,disabled:v||!y},v?a("span",{className:"tvs-spinner","aria-hidden":"true"}):null,v?" Starting...":"Start Activity"):a("div",{className:"tvs-alert tvs-alert--warning"},a("div",{className:"tvs-row tvs-mb-2"},a("span",{className:"tvs-badge tvs-badge-warning"},"Warning"),a("strong",null," You must be logged in")),a("p",null,"Please ",a("a",{href:"/login"},"log in")," to create activities and upload to Strava. Don't have an account? ",a("a",{href:"/register"},"Register here"),"."))),U?a(ne,{React:T,routeId:o,lastStatus:x,lastError:M,currentTime:b,duration:J}):null)}U||document.addEventListener("keydown",t=>{if(t.key==="`"){try{localStorage.setItem("tvsDev","1")}catch{}location.reload()}});function ue(){let t=document.getElementById("tvs-app-root");if(t){let o=window.tvs_route_payload||null,c=t.getAttribute("data-route-id")||o&&o.id;l("Boot \u2192 routeId:",c,"inline payload:",!!o),de(ae,{initialData:o,routeId:c},t)}}U?l("Debug mode enabled."):document.addEventListener("keydown",function(t){if(t.key==="`"){let o=new URL(location.href);o.searchParams.set("tvsdebug","1"),location.href=o.toString()}});document.readyState==="loading"?document.addEventListener("DOMContentLoaded",ue):ue();})();
//# sourceMappingURL=tvs-app.js.map
