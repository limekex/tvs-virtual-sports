(()=>{var M=new URLSearchParams(location.search).get("tvsdebug")==="1"||window.TVS_DEBUG===!0||localStorage.getItem("tvsDev")==="1";function l(...t){M&&console.debug("[TVS]",...t)}function m(...t){console.error("[TVS]",...t)}var le=!!(window.React&&window.ReactDOM),ye=!!(window.wp&&window.wp.element),D=ye?window.wp.element:{},T=le?window.React:D||{},_=le?window.ReactDOM:D||null,Z=new WeakMap,we=_&&typeof _.createRoot=="function"||D&&typeof D.createRoot=="function";function de(t,r,c){try{let n=Z.get(c);if(n&&typeof n.unmount=="function"?(n.unmount(),Z.delete(c)):_&&typeof _.unmountComponentAtNode=="function"&&_.unmountComponentAtNode(c),we){let u=(_&&_.createRoot||D&&D.createRoot)(c);Z.set(c,u),u.render(T.createElement(t,r));return}let w=_&&_.render||D&&D.render;if(w){w(T.createElement(t,r),c);return}m("Ingen render-funksjon tilgjengelig.")}catch(n){m("Mount feilet:",n)}}function W(t){return new Promise(r=>setTimeout(r,t))}async function K(t,r,c="operation"){let n;try{return await Promise.race([t,new Promise((w,s)=>{n=setTimeout(()=>s(new Error(c+" timed out")),r)})])}finally{clearTimeout(n)}}function ee({React:t,currentTime:r,duration:c}){let n=t.createElement,w=Math.floor(r/60),s=Math.floor(r%60),u=(I,d)=>I+":"+(d<10?"0":"")+d,U=c>0?r/c*100:0;return n("div",{className:"tvs-progress"},n("div",{className:"tvs-progress__bar"},n("div",{className:"tvs-progress__fill",style:{width:Math.min(U,100)+"%"}})),n("div",{className:"tvs-progress__time"},u(w,s)+" / "+u(Math.floor(c/60),Math.floor(c%60))))}function te(){let t=T.createElement;return t("div",{className:"tvs-loading",role:"status","aria-live":"polite"},t("svg",{viewBox:"0 0 64 64",className:"tvs-runner","aria-hidden":"true"},t("line",{x1:4,y1:60,x2:60,y2:60,stroke:"#bbb",strokeWidth:2,className:"track"}),t("circle",{cx:26,cy:12,r:5,fill:"none",stroke:"#111",strokeWidth:2}),t("line",{x1:26,y1:17,x2:26,y2:35,stroke:"#111",strokeWidth:2}),t("line",{x1:26,y1:22,x2:40,y2:18,stroke:"#111",strokeWidth:2,className:"arm front",style:{transformOrigin:"26px 22px"}}),t("line",{x1:26,y1:22,x2:12,y2:26,stroke:"#111",strokeWidth:2,className:"arm back",style:{transformOrigin:"26px 22px"}}),t("line",{x1:26,y1:35,x2:40,y2:48,stroke:"#111",strokeWidth:2,className:"leg front",style:{transformOrigin:"26px 35px"}}),t("line",{x1:26,y1:35,x2:16,y2:54,stroke:"#111",strokeWidth:2,className:"leg back",style:{transformOrigin:"26px 35px"}})),t("div",null,t("div",{className:"tvs-skel line"}),t("div",{className:"tvs-skel line sm"}),t("div",null,t("span",{className:"tvs-skel block"}),t("span",{className:"tvs-skel block"}),t("span",{className:"tvs-skel block"}))))}function ae({React:t,routeId:r,lastStatus:c,lastError:n,currentTime:w,duration:s}){let{useEffect:u,useRef:U,useState:I,createElement:d}=t;function g(L){let{useEffect:P,useRef:o,useState:O}=L,[A,b]=O(0),V=o(performance.now()),p=o(0);return P(()=>{let k,y=F=>{p.current+=1,F-V.current>=1e3&&(b(p.current),p.current=0,V.current=F),k=requestAnimationFrame(y)};return k=requestAnimationFrame(y),()=>cancelAnimationFrame(k)},[]),A}let R=g(t),X=U(null),[C,j]=I(!1),[x,ne]=I({x:16,y:16});u(()=>{if(!X.current)return;let P,o,O,A,b=!1;function V(y){y.target.closest(".tvs-dev__header")&&(b=!0,P=y.clientX,o=y.clientY,O=x.x,A=x.y,y.preventDefault())}function p(y){b&&ne({x:O+(y.clientX-P),y:A+(y.clientY-o)})}function k(){b=!1}return window.addEventListener("mousedown",V),window.addEventListener("mousemove",p),window.addEventListener("mouseup",k),()=>{window.removeEventListener("mousedown",V),window.removeEventListener("mousemove",p),window.removeEventListener("mouseup",k)}},[x]);let $=s>0?(w/s*100).toFixed(1):"0.0",f={env:window.TVS_SETTINGS?.env,version:window.TVS_SETTINGS?.version,restRoot:window.TVS_SETTINGS?.restRoot,user:window.TVS_SETTINGS?.user,routeId:r,lastStatus:c||"idle",lastError:n?String(n):null,currentTime:w?w.toFixed(1):"0.0",duration:s||0,progress:$+"%",fps:R};function h(L,P,o){return d("div",{className:"tvs-dev__row"},d("span",null,L),d("code",{className:o?"tvs-dev__err":""},P))}function re(){navigator.clipboard.writeText(JSON.stringify({...f,time:new Date().toISOString()},null,2)).catch(console.error)}return d("div",{ref:X,className:`tvs-dev ${C?"is-min":""}`,style:{left:x.x+"px",top:x.y+"px"}},d("div",{className:"tvs-dev__header"},d("strong",null,"TVS Dev"),d("div",{className:"tvs-dev__spacer"}),d("span",{className:"tvs-dev__pill"},f.env||"n/a"),d("button",{className:"tvs-dev__btn",onClick:()=>j(!C),"aria-label":"Minimize"},"\u2581")),d("div",{className:"tvs-dev__body"},h("Route",f.routeId??"n/a"),h("User",f.user??"guest"),h("REST",f.restRoot??"n/a"),h("Status",f.lastStatus),f.lastError?h("Error",f.lastError,!0):null,h("Duration",f.duration+"s"),h("Current",f.currentTime+"s"),h("Progress",f.progress),h("FPS",String(f.fps)),d("div",{className:"tvs-dev__actions"},d("button",{onClick:re,className:"tvs-dev__btn"},"Copy debug"),d("button",{onClick:()=>{localStorage.setItem("tvsDev","0"),location.reload()},className:"tvs-dev__btn tvs-dev__btn--ghost"},"Disable"))))}var B=Number(new URLSearchParams(location.search).get("tvsslow")||0);function se({initialData:t,routeId:r}){let{useEffect:c,useState:n,useRef:w,createElement:s}=T,[u,U]=n(t||null),[I,d]=n(null),[g,R]=n(!1),[X,C]=n(!1),[j,x]=n(null),[ne,$]=n([]),[f,h]=n(!1),[re,L]=n(null),[P,o]=n(t?"inline":"loading"),[O,A]=n(null),[b,V]=n(0),[p,k]=n(!1),y=w(null),F=w(null);function S(a,e="success"){typeof window.tvsFlash=="function"&&window.tvsFlash(a,e)}c(()=>{let a=new URLSearchParams(location.search).get("tvsforcefetch")==="1";if(u&&!a){l("Har inline payload, skipper fetch.",u);return}if(!r){d("Mangler routeId \u2013 hverken inline payload eller data-route-id.");return}(async()=>{try{l("Henter rute via REST:",r," (tvsslow:",B,"ms)"),o("loading"),B&&await W(B);let i=await(await fetch(`/wp-json/tvs/v1/routes/${encodeURIComponent(r)}`,{credentials:"same-origin"})).json();l("REST OK:",i),U(i),o("ok")}catch(e){m("REST FAIL:",e),d("Kunne ikke hente rutedata."),A(e?.message||String(e)),o("error")}})()},[r]),c(()=>{z()},[]);async function z(){try{h(!0);let e=await fetch("/wp-json/tvs/v1/activities/me",{credentials:"same-origin",headers:{"X-TVS-Nonce":window.TVS_SETTINGS?.nonce||""}});if(!e.ok)throw new Error("Failed to load activities");let i=await e.json(),E=Array.isArray(i)?i:i.activities||[];$(E)}catch(a){m("Load activities FAIL:",a),$([])}finally{h(!1)}}c(()=>{if(!u)return;let a=y.current;if(!a)return;let e=null,i=!1;function E(){return new Promise((v,Y)=>{if(window.Vimeo&&window.Vimeo.Player)return v();let G=document.querySelector('script[src="https://player.vimeo.com/api/player.js"]');if(G){G.addEventListener("load",()=>v()),G.addEventListener("error",()=>Y(new Error("Vimeo API failed to load")));return}let N=document.createElement("script");N.src="https://player.vimeo.com/api/player.js",N.async=!0,N.onload=()=>v(),N.onerror=()=>Y(new Error("Vimeo API failed to load")),document.head.appendChild(N)})}return(async()=>{try{if(await E(),i)return;e=new window.Vimeo.Player(a),F.current=e,l("Vimeo Player constructed"),e.getDuration().catch(()=>{});try{await e.ready(),i||(k(!0),l("Vimeo Player ready"))}catch(v){m("Vimeo ready() rejected:",v)}e.on("timeupdate",v=>{typeof v?.seconds=="number"&&V(v.seconds)})}catch{m("Vimeo API init failed")}})(),()=>{i=!0;try{e&&e.off&&e.off("timeupdate"),e&&e.destroy&&e.destroy()}catch{}F.current=null,k(!1)}},[u]);async function q(a=8e3){let e=Date.now();for(;Date.now()-e<a;){let i=F.current;if(i)try{return await i.ready(),k(!0),i}catch{}await W(100)}throw new Error("Video player is not ready")}function me(a){let e=u?.meta||{},i=Number(e.duration_s||0),E=Number(e.distance_m||0);if(i>0&&E>0&&a>=0){let v=Math.min(1,a/i);return Math.round(E*v)}return 0}async function oe(){try{R(!0),l("Start clicked");let a=await q();o("starting");try{await K(a.play(),4e3,"play()"),l("Playback started")}catch(e){throw m("play() failed:",e),S("Could not start playback: "+(e?.message||String(e)),"error"),e}try{let e=await K(a.getCurrentTime(),1500,"getCurrentTime");typeof e=="number"&&e>.5?(await W(150),await K(a.setCurrentTime(0),2e3,"setCurrentTime(0)"),l("Seeked to 0")):l("Already at start, skipping seek")}catch(e){l("Post-play seek skipped:",e?.message||String(e))}x(new Date),C(!0),o("running"),S("Activity started")}catch(a){m("Start session failed:",a),S("Player not ready yet. Please wait a moment and try again.","error"),o("error")}finally{R(!1)}}async function ve(){try{R(!0),l("Resume clicked");let a=await q();o("starting");try{await a.play(),l("Playback resumed")}catch(e){throw m("resume play() failed:",e),S("Could not resume playback: "+(e?.message||String(e)),"error"),e}C(!0),o("running"),S("Activity resumed")}catch(a){m("Resume session failed:",a),S("Player not ready yet. Please wait a moment and try again.","error"),o("error")}finally{R(!1)}}async function fe(){try{l("Pause clicked");let a=await q();try{await a.pause(),l("Playback paused")}catch(e){throw m("pause() failed:",e),S("Failed to pause: "+(e?.message||String(e)),"error"),e}C(!1),o("paused"),S("Activity paused")}catch(a){m("[TVS] Pause failed:",a),o("error")}}async function ie(){try{R(!0),l("Finish clicked");let a=await q();o("saving");try{await a.pause(),l("Playback paused before save")}catch(Q){m("pause before save failed:",Q)}let e=await a.getCurrentTime(),i=Math.max(0,Math.floor(e||0)),E=j?j.toISOString():new Date(Date.now()-i*1e3).toISOString(),v=me(i),Y={route_id:u.id,route_name:u.title||"Unknown Route",activity_date:new Date().toISOString(),started_at:E,duration_s:i,distance_m:v},G=window.TVS_SETTINGS?.nonce||"";B&&await W(B);let N=await fetch("/wp-json/tvs/v1/activities",{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":G},credentials:"same-origin",body:JSON.stringify(Y)});if(!N.ok){let Q=await N.json();throw new Error(Q.message||`HTTP ${N.status}`)}await N.json(),S("Activity saved!"),o("ok"),C(!1),x(null),await z(),window.dispatchEvent(new CustomEvent("tvs:activity-updated"))}catch(a){m("[TVS] Save activity failed:",a),S("Failed to save activity: "+(a?.message||String(a)),"error"),A(a?.message||String(a)),o("error")}finally{R(!1)}}async function ge(a){try{L(a),o("uploading");let e=await fetch(`/wp-json/tvs/v1/activities/${a}/strava`,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":window.TVS_SETTINGS?.nonce||""},credentials:"same-origin"}),i=await e.json();if(!e.ok)throw new Error(i.message||"Upload failed");S("Uploaded to Strava!"),o("ok"),await z(),window.dispatchEvent(new CustomEvent("tvs:activity-updated"))}catch(e){m("Strava upload FAIL:",e),S("Failed to upload to Strava: "+(e?.message||String(e)),"error"),A(e?.message||String(e)),o("error")}finally{L(null)}}if(I)return s("div",{className:"tvs-route tvs-error"},String(I));if(!u)return T.createElement(te,null);let he=u.title||"Route",H=u.meta||{},ce=H.vimeo_id?String(H.vimeo_id):"",J=Number(H.duration_s||0),pe=!!window.TVS_SETTINGS?.user;return s("div",{className:"tvs-app"},ce?s("div",{className:"tvs-video"},s("iframe",{ref:y,width:560,height:315,src:"https://player.vimeo.com/video/"+encodeURIComponent(ce)+"?controls=0&title=0&byline=0&portrait=0&pip=0&playsinline=1&dnt=1&transparent=0&muted=0",frameBorder:0,allow:"autoplay; fullscreen; picture-in-picture",allowFullScreen:!0})):null,new URLSearchParams(location.search).get("tvsdebug")==="1"||window.TVS_DEBUG===!0||localStorage.getItem("tvsDev")==="1"?s("div",{className:"tvs-meta"},s("pre",null,JSON.stringify(H,null,2))):null,s(ee,{React:T,currentTime:b,duration:J}),s("div",{className:"tvs-btns"},pe?X?[s("button",{key:"pause",className:"tvs-btn tvs-btn--warning",onClick:fe,disabled:g||!p,"aria-label":"Pause activity",title:"Pause activity"},"\u23F8"),s("button",{key:"finish",className:"tvs-btn tvs-btn--success",onClick:ie,disabled:g||!p,"aria-label":"Finish and save activity",title:"Finish and save activity"},g?s("span",{className:"tvs-spinner","aria-hidden":"true"}):"\u2714")]:b>0&&j&&(J===0||b<J-.5)?[s("button",{key:"resume",className:"tvs-btn",onClick:ve,disabled:g||!p,"aria-label":"Resume activity",title:"Resume activity"},g?s("span",{className:"tvs-spinner","aria-hidden":"true"}):"\u25B6"),s("button",{key:"finish",className:"tvs-btn tvs-btn--success",onClick:ie,disabled:g||!p,"aria-label":"Finish and save activity",title:"Finish and save activity"},g?s("span",{className:"tvs-spinner","aria-hidden":"true"}):"\u2714"),s("button",{key:"restart",className:"tvs-btn tvs-btn--muted",onClick:oe,disabled:g||!p,"aria-label":"Restart from beginning",title:"Restart from beginning"},"\u27F2")]:s("button",{className:"tvs-btn",onClick:oe,disabled:g||!p,"aria-label":"Start activity",title:"Start activity"},g?s("span",{className:"tvs-spinner","aria-hidden":"true"}):"\u25B6"):s("div",{className:"tvs-alert tvs-alert--warning"},s("div",{className:"tvs-row tvs-mb-2"},s("span",{className:"tvs-badge tvs-badge-warning"},"Warning"),s("strong",null," You must be logged in")),s("p",null,"Please ",s("a",{href:"/login"},"log in")," to create activities and upload to Strava. Don't have an account? ",s("a",{href:"/register"},"Register here"),"."))),M?s(ae,{React:T,routeId:r,lastStatus:P,lastError:O,currentTime:b,duration:J}):null)}M||document.addEventListener("keydown",t=>{if(t.key==="`"){try{localStorage.setItem("tvsDev","1")}catch{}location.reload()}});function ue(){let t=document.getElementById("tvs-app-root");if(t){let r=window.tvs_route_payload||null,c=t.getAttribute("data-route-id")||r&&r.id;l("Boot \u2192 routeId:",c,"inline payload:",!!r),de(se,{initialData:r,routeId:c},t)}}M?l("Debug mode enabled."):document.addEventListener("keydown",function(t){if(t.key==="`"){let r=new URL(location.href);r.searchParams.set("tvsdebug","1"),location.href=r.toString()}});document.readyState==="loading"?document.addEventListener("DOMContentLoaded",ue):ue();})();
//# sourceMappingURL=tvs-app.js.map
