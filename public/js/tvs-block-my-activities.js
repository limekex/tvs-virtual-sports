(()=>{var N=new URLSearchParams(location.search).get("tvsdebug")==="1"||window.TVS_DEBUG===!0||localStorage.getItem("tvsDev")==="1";function T(...s){N&&console.debug("[TVS]",...s)}function w(...s){console.error("[TVS]",...s)}var U=!!(window.React&&window.ReactDOM),L=!!(window.wp&&window.wp.element),f=L?window.wp.element:{},A=U?window.React:f||{},d=U?window.ReactDOM:f||null,R=new WeakMap,V=d&&typeof d.createRoot=="function"||f&&typeof f.createRoot=="function";function C(s,n,o){try{let e=R.get(o);if(e&&typeof e.unmount=="function"?(e.unmount(),R.delete(o)):d&&typeof d.unmountComponentAtNode=="function"&&d.unmountComponentAtNode(o),V){let t=(d&&d.createRoot||f&&f.createRoot)(o);R.set(o,t),t.render(A.createElement(s,n));return}let m=d&&d.render||f&&f.render;if(m){m(A.createElement(s,n),o);return}w("Ingen render-funksjon tilgjengelig.")}catch(e){w("Mount feilet:",e)}}function x({activity:s,uploadToStrava:n,uploading:o,React:e,compact:m,dummy:p}){let{createElement:t,useState:l}=e,c=s.meta||{},u=s.id,v=c._tvs_synced_strava?.[0]||c.synced_strava?.[0],y=c._tvs_strava_remote_id?.[0]||c.strava_activity_id?.[0],_=v==="1"||v===1,i=c._tvs_distance_m?.[0]||c.distance_m?.[0]||0,a=c._tvs_duration_s?.[0]||c.duration_s?.[0]||0,r=c._tvs_route_name?.[0]||c.route_name?.[0]||"Unknown Route",h=c._tvs_activity_date?.[0]||c.activity_date?.[0]||s.date||"",k="";if(h)try{k=new Date(h).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"})}catch{k=h}let M=k?`${r} (${k})`:r;if(m){let[S,b]=l(!1);return p?t("div",{className:"tvs-activity-card-compact is-dummy"},t("div",{className:"tvs-activity-card__row"},t("div",{style:{flex:1,minWidth:0}},t("div",{className:"tvs-activity-card__title"},M),t("div",{className:"tvs-activity-card__meta tvs-text-muted"},i>0?(i/1e3).toFixed(2)+" km":"",i>0&&a>0?" \xB7 ":"",a>0?Math.floor(a/60)+" min":"")),t("div",{className:"tvs-activity-card__actions",style:{flexShrink:0}},t("span",{className:"tvs-text-muted",title:"Preview",style:{fontSize:"1.25rem",lineHeight:1,display:"flex",alignItems:"center"}},"\u2713"),t("div",{className:"tvs-strava-square",style:{background:"#e5e7eb",color:"#ccc"}},"S")))):t("div",{className:"tvs-activity-card-compact"},t("div",{className:"tvs-activity-card__row"},t("div",{style:{flex:1,minWidth:0}},t("div",{className:"tvs-activity-card__title"},M),t("div",{className:"tvs-activity-card__meta tvs-text-muted"},i>0?(i/1e3).toFixed(2)+" km":"",i>0&&a>0?" \xB7 ":"",a>0?Math.floor(a/60)+" min":"")),t("div",{className:"tvs-activity-card__actions",style:{flexShrink:0}},_?t("span",{className:"tvs-text-success",title:"Synced to Strava",style:{fontSize:"1.25rem",lineHeight:1,display:"flex",alignItems:"center"}},"\u2713"):null,t("div",{style:{position:"relative"}},_?t("a",{href:y?"https://www.strava.com/activities/"+y:"#",target:"_blank",rel:"noopener noreferrer",title:"View on Strava",className:"tvs-strava-square"},"S"):t("button",{onClick:g=>{g.stopPropagation(),b(!S)},disabled:o,title:"Upload to Strava",className:"tvs-strava-square"},o?"...":"S"),S&&!_&&!o?t("div",{className:"tvs-popover"},t("div",{className:"tvs-popover__title"},"Upload to Strava?"),t("div",{className:"tvs-popover__actions"},t("button",{onClick:g=>{g.stopPropagation(),b(!1),n(u)},className:"tvs-btn tvs-btn-strava",style:{flex:1}},"Upload"),t("button",{onClick:g=>{g.stopPropagation(),b(!1)},className:"tvs-btn tvs-btn--muted",style:{flex:1}},"Cancel"))):null))),S?t("div",{style:{position:"fixed",inset:0,zIndex:999},onClick:()=>b(!1)}):null)}return t("div",{className:"tvs-activity-card"+(_?" tvs-activity-card--synced":"")},t("div",{className:"tvs-activity-card__row"},t("div",null,t("strong",null,M),t("div",{className:"tvs-activity-card__meta tvs-text-muted"},i>0?t("span",null,"Distance: "+(i/1e3).toFixed(2)+" km "):null,a>0?t("span",null,"Duration: "+Math.floor(a/60)+" min"):null)),t("div",{className:"tvs-activity-card__right"},_?t("div",null,t("span",{className:"tvs-text-success",style:{fontWeight:"bold"}},"\u2713 Synced to Strava"),y?t("a",{href:"https://www.strava.com/activities/"+y,target:"_blank",rel:"noopener noreferrer",className:"tvs-link tvs-text-sm",style:{display:"block",marginTop:"0.25rem"}},"View on Strava \u2192"):null):t("button",{className:"tvs-btn tvs-btn-strava",onClick:()=>n(u),disabled:o},o?"Uploading...":"Upload to Strava"))))}function E({React:s,activities:n,loadingActivities:o,uploadToStrava:e,uploadingId:m}){let{useState:p,createElement:t}=s,[l,c]=p(!1),u=n.slice(0,5);return t("div",{className:"tvs-activities-block tvs-panel"},t("div",{className:"tvs-activities-header"},t("h3",{className:"tvs-activities-title"},"Recent Activities"),t("button",{onClick:()=>c(!l),className:"tvs-icon-btn","aria-label":l?"Expand":"Minimize"},l?"\u25B8":"\u25BE")),l?null:o?t("p",{className:"tvs-text-muted"},"Loading activities..."):u.length===0?t("p",{className:"tvs-text-muted"},"Start a new activity when you're ready"):t("div",null,t("div",{className:"tvs-activities-list"},u.map(v=>t(x,{key:v.id,activity:v,uploadToStrava:e,uploading:m===v.id,React:s,compact:!0}))),t("div",{className:"tvs-activities-footer"},t("a",{href:"/my-activities",className:"tvs-link tvs-text-sm"},"Go to my activities \u2192"))))}function D({React:s}){let{useState:n,useEffect:o,createElement:e}=s,[m,p]=n([]),[t,l]=n(!1),[c,u]=n(null),v=!!window.TVS_SETTINGS?.user;o(()=>{if(!v)return;y();let i=()=>{N&&console.info("[TVS] MyActivitiesStandalone: Received activity update event, reloading..."),y()};return window.addEventListener("tvs:activity-updated",i),()=>{window.removeEventListener("tvs:activity-updated",i)}},[]);async function y(){try{l(!0);let a=await fetch("/wp-json/tvs/v1/activities/me",{credentials:"same-origin",headers:{"X-TVS-Nonce":window.TVS_SETTINGS?.nonce||""}});if(!a.ok)throw new Error("Failed to load activities");let r=await a.json(),h=Array.isArray(r)?r:r.activities||[];p(h)}catch(i){w("Load activities FAIL:",i),p([])}finally{l(!1)}}async function _(i){try{u(i);let a=await fetch(`/wp-json/tvs/v1/activities/${i}/strava`,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":window.TVS_SETTINGS?.nonce||""},credentials:"same-origin"}),r=await a.json();if(!a.ok)throw new Error(r.message||"Upload failed");window.tvsFlash("Uploaded to Strava!"),await y(),window.dispatchEvent(new CustomEvent("tvs:activity-updated"))}catch(a){w("Strava upload FAIL:",a),window.tvsFlash("Failed to upload to Strava: "+(a?.message||String(a)),"error")}finally{u(null)}}if(!v){let i=Array.from({length:3}).map((a,r)=>({id:"dummy-"+r,meta:{_tvs_route_name:["Sample Route "+(r+1)],_tvs_activity_date:[new Date(Date.now()-r*864e5).toISOString()],_tvs_distance_m:[Math.round(5e3+Math.random()*5e3)],_tvs_duration_s:[Math.round(1200+Math.random()*1800)]}}));return e("div",{className:"tvs-activities-block tvs-panel"},e("h3",{className:"tvs-activities-title"},"My Activities"),e("div",{className:"tvs-activities-list"},i.map(a=>e(x,{key:a.id,activity:a,React:s,compact:!0,dummy:!0}))),e("div",{className:"tvs-activities-footer"},e("div",{className:"tvs-text-muted",style:{marginBottom:"0.5rem"}},"Sign in to see your recent activities."),e("div",null,e("a",{href:"/login",className:"tvs-link",style:{marginRight:12}},"Log in"),e("a",{href:"/register",className:"tvs-link"},"Register"))))}return e(E,{React:s,activities:m,loadingActivities:t,uploadToStrava:_,uploadingId:c})}function I(){document.querySelectorAll(".tvs-my-activities-block").forEach((n,o)=>{if(!n.__tvsMounted){let e=n.id||`tvs-my-activities-${o}`;n.id||(n.id=e),N&&T("Mounting MyActivities block (view.js) on:",e),C(D,{React:A},n),n.__tvsMounted=!0}})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",I):I();})();
//# sourceMappingURL=tvs-block-my-activities.js.map
