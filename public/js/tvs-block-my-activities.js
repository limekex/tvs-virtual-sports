(()=>{var A=new URLSearchParams(location.search).get("tvsdebug")==="1"||window.TVS_DEBUG===!0||localStorage.getItem("tvsDev")==="1";function L(...i){A&&console.debug("[TVS]",...i)}function b(...i){console.error("[TVS]",...i)}var $=!!(window.React&&window.ReactDOM),j=!!(window.wp&&window.wp.element),h=j?window.wp.element:{},D=$?window.React:h||{},g=$?window.ReactDOM:h||null,T=new WeakMap,F=g&&typeof g.createRoot=="function"||h&&typeof h.createRoot=="function";function V(i,a,s){try{let o=T.get(s);if(o&&typeof o.unmount=="function"&&(o.unmount(),T.delete(s)),F){let t=(g&&g.createRoot||h&&h.createRoot)(s);T.set(s,t),t.render(D.createElement(i,a));return}g&&typeof g.unmountComponentAtNode=="function"&&g.unmountComponentAtNode(s);let d=g&&g.render||h&&h.render;if(d){d(D.createElement(i,a),s);return}b("Ingen render-funksjon tilgjengelig.")}catch(o){b("Mount feilet:",o)}}function M({activity:i,uploadToStrava:a,uploading:s,React:o,compact:d,dummy:y}){let{createElement:t,useState:n}=o,e=i.meta||{},S=i.id,f=i.permalink||"",N=e._tvs_synced_strava?.[0]||e.synced_strava?.[0],l=e._tvs_strava_remote_id?.[0]||e.strava_activity_id?.[0],_=N==="1"||N===1,m=e._tvs_distance_m?.[0]||e.distance_m?.[0]||0,u=e._tvs_duration_s?.[0]||e.duration_s?.[0]||0,r=e._tvs_route_name?.[0]||e.route_name?.[0]||"Unknown Route",c=e._tvs_activity_date?.[0]||e.activity_date?.[0]||i.date||"",p=e._tvs_activity_type?.[0]||e.activity_type?.[0]||"",k=e._tvs_manual_exercises?.[0],w=[];if(k)try{w=JSON.parse(k)}catch{w=[]}let U=p==="Workout"&&w.length>0,E="";if(c)try{E=new Date(c).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"})}catch{E=c}let P=E?`${r} (${E})`:r;if(d){let[x,R]=n(!1);return y?t("div",{className:"tvs-activity-card-compact is-dummy"},t("div",{className:"tvs-activity-card__row"},t("div",{style:{flex:1,minWidth:0}},t("div",{className:"tvs-activity-card__title"},"Mock activity (demo) \xB7 ",t("span",{className:"tvs-badge tvs-badge-info"},"Demo")),t("div",{className:"tvs-activity-card__meta tvs-text-muted"},m>0?(m/1e3).toFixed(2)+" km":"",m>0&&u>0?" \xB7 ":"",u>0?Math.floor(u/60)+" min":"")),t("div",{className:"tvs-activity-card__actions",style:{flexShrink:0}},t("span",{className:"tvs-text-muted",title:"Preview",style:{fontSize:"1.25rem",lineHeight:1,display:"flex",alignItems:"center"}},"\u2713"),t("div",{className:"tvs-strava-square",style:{background:"#e5e7eb",color:"#ccc"}},"S")))):t("div",{className:"tvs-activity-card-compact",...f?{onClick:()=>{window.location.href=f},role:"link",tabIndex:0,onKeyDown:v=>{(v.key==="Enter"||v.key===" ")&&(v.preventDefault(),window.location.href=f)},style:{cursor:"pointer"}}:{}},t("div",{className:"tvs-activity-card__row"},t("div",{style:{flex:1,minWidth:0}},t("div",{className:"tvs-activity-card__title"},P),t("div",{className:"tvs-activity-card__meta tvs-text-muted"},U?`${w.length} exercise${w.length!==1?"s":""} \xB7 ${Math.floor(u/60)} min`:(m>0?(m/1e3).toFixed(2)+" km":"")+(m>0&&u>0?" \xB7 ":"")+(u>0?Math.floor(u/60)+" min":""))),t("div",{className:"tvs-activity-card__actions",style:{flexShrink:0},onClick:v=>v.stopPropagation(),onKeyDown:v=>v.stopPropagation()},_?t("span",{className:"tvs-text-success",title:"Synced to Strava",style:{fontSize:"1.25rem",lineHeight:1,display:"flex",alignItems:"center"}},"\u2713"):null,t("div",{style:{position:"relative"}},_?t("a",{href:l?"https://www.strava.com/activities/"+l:"#",target:"_blank",rel:"noopener noreferrer",title:"View on Strava",className:"tvs-strava-square"},"S"):t("button",{onClick:v=>{v.stopPropagation(),R(!x)},disabled:s,title:"Upload to Strava",className:"tvs-strava-square"},s?"...":"S"),x&&!_&&!s?t("div",{className:"tvs-popover"},t("div",{className:"tvs-popover__title"},"Upload to Strava?"),t("div",{className:"tvs-popover__actions"},t("button",{onClick:v=>{v.stopPropagation(),R(!1),a(S)},className:"tvs-btn tvs-btn-strava",style:{flex:1}},"Upload"),t("button",{onClick:v=>{v.stopPropagation(),R(!1)},className:"tvs-btn tvs-btn--muted",style:{flex:1}},"Cancel"))):null))),x?t("div",{style:{position:"fixed",inset:0,zIndex:999},onClick:()=>R(!1)}):null)}return t("div",{className:"tvs-activity-card"+(_?" tvs-activity-card--synced":"")},t("div",{className:"tvs-activity-card__row"},t("div",null,t("strong",null,P),t("div",{className:"tvs-activity-card__meta tvs-text-muted"},U?t("span",null,`${w.length} exercise${w.length!==1?"s":""} \xB7 Duration: ${Math.floor(u/60)} min`):(m>0?t("span",null,"Distance: "+(m/1e3).toFixed(2)+" km "):null)+(u>0?t("span",null,"Duration: "+Math.floor(u/60)+" min"):null))),t("div",{className:"tvs-activity-card__right"},_?t("div",null,t("span",{className:"tvs-text-success",style:{fontWeight:"bold"}},"\u2713 Synced to Strava"),l?t("a",{href:"https://www.strava.com/activities/"+l,target:"_blank",rel:"noopener noreferrer",className:"tvs-link tvs-text-sm",style:{display:"block",marginTop:"0.25rem"}},"View on Strava \u2192"):null):t("button",{className:"tvs-btn tvs-btn-strava",onClick:()=>a(S),disabled:s},s?"Uploading...":"Upload to Strava"))))}function I({React:i,activities:a,loadingActivities:s,uploadToStrava:o,uploadingId:d,title:y}){let{useState:t,createElement:n}=i,[e,S]=t(!1),f=a.slice(0,5),N=y&&String(y).trim()?String(y):"Recent Activities";return n("div",{className:"tvs-activities-block tvs-panel"},n("div",{className:"tvs-activities-header"},n("h3",{className:"tvs-activities-title"},N),n("button",{onClick:()=>S(!e),className:"tvs-icon-btn","aria-label":e?"Expand":"Minimize"},e?"\u25B8":"\u25BE")),e?null:s?n("div",{className:"tvs-activities-list"},[0,1,2].map(l=>n("div",{key:`skel-${l}`,className:"tvs-activity-card-compact"},n("div",{className:"tvs-skel line",style:{width:"60%"}}),n("div",{className:"tvs-skel line sm",style:{width:"40%"}})))):f.length===0?n("p",{className:"tvs-text-muted"},"Start a new activity when you're ready"):n("div",null,n("div",{className:"tvs-activities-list"},f.map(l=>n(M,{key:l.id,activity:l,uploadToStrava:o,uploading:d===l.id,React:i,compact:!0}))),n("div",{className:"tvs-activities-footer"},n("a",{href:"/my-activities",className:"tvs-link tvs-text-sm"},"Go to my activities \u2192"))))}function C({React:i,routeId:a=0,limit:s=5,title:o=""}){let{useState:d,useEffect:y,createElement:t}=i,[n,e]=d([]),[S,f]=d(!1),[N,l]=d(null),_=!!window.TVS_SETTINGS?.user;y(()=>{if(!_){e([]);return}m();let r=()=>{A&&console.info("[TVS] MyActivitiesStandalone: Received activity update event, reloading..."),m()};return window.addEventListener("tvs:activity-updated",r),()=>{window.removeEventListener("tvs:activity-updated",r)}},[a,s,_]);async function m(){try{f(!0);let r=new URLSearchParams;r.set("per_page",String(s));let c=parseInt(a,10)||0;c>0&&r.set("route_id",String(c));let p=await fetch(`/wp-json/tvs/v1/activities/me?${r.toString()}`,{credentials:"same-origin",headers:{"X-TVS-Nonce":window.TVS_SETTINGS?.nonce||"","X-WP-Nonce":window.TVS_SETTINGS?.nonce||""}});if(!p.ok)throw new Error("Failed to load activities");let k=await p.json(),w=Array.isArray(k)?k:k.activities||[];e(w)}catch(r){b("Load activities FAIL:",r),e([])}finally{f(!1)}}async function u(r){try{l(r);let c=await fetch(`/wp-json/tvs/v1/activities/${r}/strava`,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":window.TVS_SETTINGS?.nonce||""},credentials:"same-origin"}),p=await c.json();if(!c.ok)throw new Error(p.message||"Upload failed");window.tvsFlash("Uploaded to Strava!"),await m(),window.dispatchEvent(new CustomEvent("tvs:activity-updated"))}catch(c){b("Strava upload FAIL:",c),window.tvsFlash("Failed to upload to Strava: "+(c?.message||String(c)),"error")}finally{l(null)}}if(!_){let r=Array.from({length:3}).map((c,p)=>({id:"dummy-"+p,meta:{_tvs_route_name:["Mock Activity Preview "+(p+1)],_tvs_activity_date:[new Date(Date.now()-p*864e5).toISOString()],_tvs_distance_m:[Math.round(5e3+Math.random()*5e3)],_tvs_duration_s:[Math.round(1200+Math.random()*1800)]}}));return t("div",{className:"tvs-activities-block tvs-panel"},t("h3",{className:"tvs-activities-title"},o&&o.trim()?o:"My Activities"),t("div",{className:"tvs-activities-list"},r.map(c=>t(M,{key:c.id,activity:c,React:i,compact:!0,dummy:!0}))),t("div",{className:"tvs-activities-footer"},t("div",{className:"tvs-text-muted",style:{marginBottom:"0.5rem"}},"Sign in to see your recent activities."),t("div",null,t("a",{href:"/login",className:"tvs-link",style:{marginRight:12}},"Log in"),t("a",{href:"/register",className:"tvs-link"},"Register"))))}return t(I,{React:i,activities:n,loadingActivities:S,uploadToStrava:u,uploadingId:N,title:o})}function W(){document.querySelectorAll(".tvs-my-activities-block").forEach((a,s)=>{if(!a.__tvsMounted){let o=a.id||`tvs-my-activities-${s}`;a.id||(a.id=o),A&&L("Mounting MyActivities block (view.js) on:",o);let d=parseInt(a.getAttribute("data-route-id")||"0",10)||0,y=parseInt(a.getAttribute("data-limit")||"5",10)||5,t=a.getAttribute("data-title")||"";V(C,{React:D,routeId:d,limit:y,title:t},a),a.__tvsMounted=!0}})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",W):W();})();
//# sourceMappingURL=tvs-block-my-activities.js.map
