(()=>{var _=new URLSearchParams(location.search).get("tvsdebug")==="1"||window.TVS_DEBUG===!0||localStorage.getItem("tvsDev")==="1";function U(...i){_&&console.debug("[TVS]",...i)}function h(...i){console.error("[TVS]",...i)}var C=!!(window.React&&window.ReactDOM),V=!!(window.wp&&window.wp.element),f=V?window.wp.element:{},k=C?window.React:f||{},d=C?window.ReactDOM:f||null,R=new WeakMap,j=d&&typeof d.createRoot=="function"||f&&typeof f.createRoot=="function";function L(i,s,n){try{let e=R.get(n);if(e&&typeof e.unmount=="function"?(e.unmount(),R.delete(n)):d&&typeof d.unmountComponentAtNode=="function"&&d.unmountComponentAtNode(n),j){let t=(d&&d.createRoot||f&&f.createRoot)(n);R.set(n,t),t.render(k.createElement(i,s));return}let m=d&&d.render||f&&f.render;if(m){m(k.createElement(i,s),n);return}h("Ingen render-funksjon tilgjengelig.")}catch(e){h("Mount feilet:",e)}}function N({React:i,size:s=16,className:n}){let{createElement:e}=i;return e("svg",{width:s,height:s,viewBox:"0 0 24 24","aria-hidden":"true",focusable:"false",className:n,fill:"currentColor"},e("path",{d:"M12 2l5.5 9h-3.5L12 6l-2 5H6.5L12 2z"}),e("path",{d:"M16 13l3 5h-2l-1-2-1 2h-2l3-5z"}))}function A({activity:i,uploadToStrava:s,uploading:n,React:e,compact:m,dummy:p}){let{createElement:t,useState:v}=e,r=i.meta||{},u=i.id,l=r._tvs_synced_strava?.[0]||r.synced_strava?.[0],w=r._tvs_strava_remote_id?.[0]||r.strava_activity_id?.[0],y=l==="1"||l===1,o=r._tvs_distance_m?.[0]||r.distance_m?.[0]||0,a=r._tvs_duration_s?.[0]||r.duration_s?.[0]||0,c=r._tvs_route_name?.[0]||r.route_name?.[0]||"Unknown Route",b=r._tvs_activity_date?.[0]||r.activity_date?.[0]||i.date||"",M="";if(b)try{M=new Date(b).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"})}catch{M=b}let x=M?`${c} (${M})`:c;if(m){let[S,E]=v(!1);return p?t("div",{className:"tvs-activity-card-compact is-disabled"},t("div",{className:"tvs-row between"},t("div",{className:"tvs-grow"},t("div",null,x),t("div",{className:"tvs-muted"},o>0?(o/1e3).toFixed(2)+" km":"",o>0&&a>0?" \xB7 ":"",a>0?Math.floor(a/60)+" min":"")),t("div",{className:"tvs-row"},t("span",{title:"Preview"},"\u2713"),t("div",{className:"tvs-btn tvs-btn-strava tvs-btn--square-sm","aria-label":"Strava"},t(N,{React:e,size:16}))))):t("div",{className:"tvs-activity-card-compact"},t("div",{className:"tvs-row between"},t("div",{className:"tvs-grow"},t("div",null,x),t("div",{className:"tvs-muted"},o>0?(o/1e3).toFixed(2)+" km":"",o>0&&a>0?" \xB7 ":"",a>0?Math.floor(a/60)+" min":"")),t("div",{className:"tvs-row tvs-no-shrink"},y?t("span",{title:"Synced to Strava"},"\u2713"):null,t("div",{className:"tvs-relative"},y?t("a",{href:w?"https://www.strava.com/activities/"+w:"#",target:"_blank",rel:"noopener noreferrer",title:"View on Strava",className:"tvs-btn tvs-btn-strava tvs-btn--square-sm","aria-label":"View on Strava"},t(N,{React:e,size:16})):t("button",{onClick:g=>{g.stopPropagation(),E(!S)},disabled:n,title:"Upload to Strava",className:"tvs-btn tvs-btn-strava tvs-btn--square-sm","aria-label":"Upload to Strava"},n?"\u2026":t(N,{React:e,size:16})),S&&!y&&!n?t("div",{className:"tvs-popover"},t("div",{className:"tvs-muted tvs-mb-2"},"Upload to Strava?"),t("div",{className:"tvs-row"},t("button",{onClick:g=>{g.stopPropagation(),E(!1),s(u)},className:"tvs-btn tvs-btn-strava tvs-flex-1"},"Upload"),t("button",{onClick:g=>{g.stopPropagation(),E(!1)},className:"tvs-btn tvs-btn--muted tvs-flex-1"},"Cancel"))):null))),S?t("div",{className:"tvs-overlay",onClick:()=>E(!1)}):null)}return t("div",{className:"tvs-activity-card"+(y?" is-synced":"")},t("div",{className:"tvs-row between"},t("div",null,t("strong",null,x),t("div",{className:"tvs-muted tvs-mt-2"},o>0?t("span",null,"Distance: "+(o/1e3).toFixed(2)+" km "):null,a>0?t("span",null,"Duration: "+Math.floor(a/60)+" min"):null)),t("div",{className:"tvs-text-right"},y?t("div",null,t("span",null,"\u2713 Synced to Strava"),w?t("a",{href:"https://www.strava.com/activities/"+w,target:"_blank",rel:"noopener noreferrer",className:"tvs-muted tvs-block tvs-mt-1"},"View on Strava \u2192"):null):t("button",{className:"tvs-btn tvs-btn-strava",onClick:()=>s(u),disabled:n},n?"Uploading...":"Upload to Strava"))))}function D({React:i,activities:s,loadingActivities:n,uploadToStrava:e,uploadingId:m}){let{useState:p,createElement:t}=i,[v,r]=p(!1),u=s.slice(0,5);return t("div",{className:"tvs-activities-block"},t("div",{className:"tvs-row between tvs-mb-4"},t("h3",null,"Recent Activities"),t("button",{onClick:()=>r(!v),className:"tvs-btn tvs-btn--ghost","aria-label":v?"Expand":"Minimize"},v?"\u25B8":"\u25BE")),v?null:n?t("p",{className:"tvs-muted"},"Loading activities..."):u.length===0?t("p",{className:"tvs-muted"},"Start a new activity when you're ready"):t("div",null,t("div",{className:"tvs-activities-list tvs-mb-4"},u.map(l=>t(A,{key:l.id,activity:l,uploadToStrava:e,uploading:m===l.id,React:i,compact:!0}))),t("div",{className:"tvs-text-center tvs-pt-2 tvs-border-top"},t("a",{href:"/my-activities",className:"tvs-muted"},"Go to my activities \u2192"))))}function T({React:i}){let{useState:s,useEffect:n,createElement:e}=i,[m,p]=s([]),[t,v]=s(!1),[r,u]=s(null),l=!!window.TVS_SETTINGS?.user;n(()=>{if(!l)return;w();let o=()=>{_&&console.info("[TVS] MyActivitiesStandalone: Received activity update event, reloading..."),w()};return window.addEventListener("tvs:activity-updated",o),()=>{window.removeEventListener("tvs:activity-updated",o)}},[]);async function w(){try{v(!0);let a=await fetch("/wp-json/tvs/v1/activities/me",{credentials:"same-origin",headers:{"X-TVS-Nonce":window.TVS_SETTINGS?.nonce||""}});if(!a.ok)throw new Error("Failed to load activities");let c=await a.json(),b=Array.isArray(c)?c:c.activities||[];p(b)}catch(o){h("Load activities FAIL:",o),p([])}finally{v(!1)}}async function y(o){try{u(o);let a=await fetch(`/wp-json/tvs/v1/activities/${o}/strava`,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":window.TVS_SETTINGS?.nonce||""},credentials:"same-origin"}),c=await a.json();if(!a.ok)throw new Error(c.message||"Upload failed");window.tvsFlash("Uploaded to Strava!"),await w(),window.dispatchEvent(new CustomEvent("tvs:activity-updated"))}catch(a){h("Strava upload FAIL:",a),window.tvsFlash("Failed to upload to Strava: "+(a?.message||String(a)),"error")}finally{u(null)}}if(!l){let o=Array.from({length:3}).map((a,c)=>({id:"dummy-"+c,meta:{_tvs_route_name:["Sample Route "+(c+1)],_tvs_activity_date:[new Date(Date.now()-c*864e5).toISOString()],_tvs_distance_m:[Math.round(5e3+Math.random()*5e3)],_tvs_duration_s:[Math.round(1200+Math.random()*1800)]}}));return e("div",{className:"tvs-activities-block"},e("h3",null,"My Activities"),e("div",{className:"tvs-activities-list tvs-mb-4"},o.map(a=>e(A,{key:a.id,activity:a,React:i,compact:!0,dummy:!0}))),e("div",{className:"tvs-muted tvs-text-center tvs-mb-2"},"Sign in to see your recent activities."),e("div",{className:"tvs-text-center"},e("a",{href:"/login",className:"tvs-btn tvs-btn--muted tvs-mr-3"},"Log in"),e("a",{href:"/register",className:"tvs-btn tvs-btn--muted"},"Register")))}return e(D,{React:i,activities:m,loadingActivities:t,uploadToStrava:y,uploadingId:r})}function I(){document.querySelectorAll(".tvs-my-activities-block").forEach((s,n)=>{if(!s.__tvsMounted){let e=s.id||`tvs-my-activities-${n}`;s.id||(s.id=e),_&&U("Mounting MyActivities block (view.js) on:",e),L(T,{React:k},s),s.__tvsMounted=!0}})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",I):I();})();
//# sourceMappingURL=tvs-block-my-activities.js.map
