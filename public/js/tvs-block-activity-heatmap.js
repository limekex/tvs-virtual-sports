(()=>{var pt=new URLSearchParams(location.search).get("tvsdebug")==="1"||window.TVS_DEBUG===!0||localStorage.getItem("tvsDev")==="1";function et(...y){console.error("[TVS]",...y)}var at=!!(window.React&&window.ReactDOM),mt=!!(window.wp&&window.wp.element),W=mt?window.wp.element:{},Q=at?window.React:W||{},U=at?window.ReactDOM:W||null,nt=new WeakMap,ft=U&&typeof U.createRoot=="function"||W&&typeof W.createRoot=="function";function ot(y,d,r){try{let x=nt.get(r);if(x&&typeof x.unmount=="function"&&(x.unmount(),nt.delete(r)),ft){let M=(U&&U.createRoot||W&&W.createRoot)(r);nt.set(r,M),M.render(Q.createElement(y,d));return}U&&typeof U.unmountComponentAtNode=="function"&&U.unmountComponentAtNode(r);let k=U&&U.render||W&&W.render;if(k){k(Q.createElement(y,d),r);return}et("Ingen render-funksjon tilgjengelig.")}catch(x){et("Mount feilet:",x)}}function rt({React:y,data:d,showDistance:r,showPace:x,showCumulative:k}){let{createElement:u,useEffect:M,useRef:s,useState:$}=y,L=s(null),b=s(null),D=s(null),G=s(null),P=s(null),v=s([]),C=s([]),[O,F]=$(!1);return M(()=>{function f(){let w=b.current,E=L.current;if(!w||!E)return;let S=E.getBoundingClientRect(),t=Math.max(40,Math.floor(S.width)),i=Math.max(40,Math.floor(S.height)),c=Math.min(2,window.devicePixelRatio||1);w.width=Math.floor(t*c),w.height=Math.floor(i*c),w.style.width=t+"px",w.style.height=i+"px";let n=w.getContext("2d");n.setTransform(1,0,0,1,0,0),n.scale(c,c),n.clearRect(0,0,t,i);let a=d&&d.items?d.items.slice().sort((e,h)=>e.date<h.date?-1:e.date>h.date?1:0):null;C.current=a||[];let m=a?a.map(e=>e.count||0):Array.from({length:20},()=>Math.floor(Math.random()*5)),g=a?a.map(e=>e.distance_km||0):Array(m.length).fill(0),T=a?a.map(e=>typeof e.avg_pace_s_per_km=="number"?e.avg_pace_s_per_km:0):Array(m.length).fill(0);function A(e,h=7){if(!e||e.length===0)return e;let B=new Array(e.length).fill(0),H=Math.floor(h/2);for(let R=0;R<e.length;R++){let K=0,q=0;for(let X=R-H;X<=R+H;X++)X>=0&&X<e.length&&(K+=e[X],q++);B[R]=q?K/q:e[R]}return B}let j=A(g),V=A(T),z=Math.max(1,...m),o=Math.max(1,...j),l=Math.max(1,...V),N=Math.min(...V.filter(e=>e>0))||0;function _(e){return e.map((h,B)=>{let H=Math.max(1,e.length-1),R=B/H*(t-4)+2,K=(1-h/Math.max(1,Math.max(...e)))*(i-6)+3,q=a&&a[B]?a[B].date:null;return{x:R,y:K,v:h,i:B,date:q}})}let I=_(m),Z=_(j);function Y(e){let h=N,B=Math.max(h+1,l);return e.map((H,R)=>{let K=Math.max(1,e.length-1),q=R/K*(t-4)+2,ut=(H-h)/(B-h)*(i-6)+3,dt=a&&a[R]?a[R].date:null;return{x:q,y:ut,v:H,i:R,date:dt}})}let J=Y(V),st=0,tt=g.map(e=>(st+=e,st)),lt=_(tt);v.current=I,n.strokeStyle="#0ea5e9",n.lineWidth=2,n.beginPath(),I.forEach((e,h)=>{h===0?n.moveTo(e.x,e.y):n.lineTo(e.x,e.y)}),n.stroke(),r&&a&&o>0&&(n.strokeStyle="#16a34a",n.lineWidth=2,n.beginPath(),Z.forEach((e,h)=>{h===0?n.moveTo(e.x,e.y):n.lineTo(e.x,e.y)}),n.stroke()),x&&a&&l>0&&(n.strokeStyle="#f59e0b",n.setLineDash([4,3]),n.beginPath(),J.forEach((e,h)=>{h===0?n.moveTo(e.x,e.y):n.lineTo(e.x,e.y)}),n.stroke(),n.setLineDash([])),k&&a&&tt[tt.length-1]>0&&(n.strokeStyle="#8b5cf6",n.lineWidth=2,n.beginPath(),lt.forEach((e,h)=>{h===0?n.moveTo(e.x,e.y):n.lineTo(e.x,e.y)}),n.stroke()),F(!0)}f();let p=()=>f();return window.addEventListener("resize",p),()=>window.removeEventListener("resize",p)},[d]),M(()=>{let f=L.current;if(!f)return;let p=D.current,w=G.current,E=P.current;function S(a){let m=f.getBoundingClientRect(),g=a-m.left,T=0,A=1/0;return v.current.forEach((j,V)=>{let z=Math.abs(j.x-g);z<A&&(T=V,A=z)}),T}function t(a){let m=v.current[a];if(!m)return;let g=C.current[a];p.style.left=m.x+"px",p.style.display="block",w.style.left=m.x+"px",w.style.top=m.y+"px",w.style.display="block";let T=g&&typeof g.distance_km=="number"?`, ${g.distance_km.toFixed(1)} km`:"",A=g&&typeof g.avg_pace_s_per_km=="number"?`, ${new Date(g.avg_pace_s_per_km*1e3).toISOString().substr(14,5)}/km`:"";E.textContent=m.date?`${m.date}: ${m.v}${T}${A}`:String(m.v),E.style.left=m.x+"px",E.style.top=m.y-8+"px",E.style.display="block"}function i(){p.style.display="none",w.style.display="none",E.style.display="none"}function c(a){let m=a.touches&&a.touches[0]?a.touches[0]:a,g=S(m.clientX);t(g)}function n(){i()}return f.addEventListener("mousemove",c),f.addEventListener("mouseleave",n),f.addEventListener("touchstart",c,{passive:!0}),f.addEventListener("touchmove",c,{passive:!0}),f.addEventListener("touchend",n),()=>{f.removeEventListener("mousemove",c),f.removeEventListener("mouseleave",n),f.removeEventListener("touchstart",c),f.removeEventListener("touchmove",c),f.removeEventListener("touchend",n)}},[]),u("div",{ref:L,className:"tvs-sparkline"},u("canvas",{ref:b,width:220,height:40}),u("div",{ref:D,className:"tvs-sparkline__guide",style:{display:"none"},"aria-hidden":"true"}),u("div",{ref:G,className:"tvs-sparkline__dot",style:{display:"none"},"aria-hidden":"true"}),u("div",{ref:P,className:"tvs-sparkline__tooltip",style:{display:"none"}}),O?u("div",{className:"tvs-spark-legend","aria-hidden":"true"},u("span",{className:"tvs-spark-legend__swatch",style:{background:"#0ea5e9"}}),u("span",null,"Count"),r?u(y.Fragment,null,u("span",{className:"tvs-spark-legend__swatch",style:{background:"#16a34a"}}),u("span",null,"KM")):null,x?u(y.Fragment,null,u("span",{className:"tvs-spark-legend__swatch",style:{background:"#f59e0b"}}),u("span",null,"Pace")):null,k?u(y.Fragment,null,u("span",{className:"tvs-spark-legend__swatch",style:{background:"#8b5cf6"}}),u("span",null,"Cum KM")):null):null)}function it({React:y,data:d}){let{createElement:r,useMemo:x,useRef:k,useEffect:u,useState:M}=y,s=k(null),$=k(null),L=k(null),b=k([]),D=x(()=>(d&&d.items||[]).slice().sort((i,c)=>i.date<c.date?-1:i.date>c.date?1:0),[d]),G=x(()=>{let t=new Map;return D.forEach(i=>t.set(i.date,i.count)),t},[D]),P=D.map(t=>t.date);if(P.length===0)return r("div",{className:"tvs-heatmap-wrap tvs-heatmap--interactive"},r("div",{className:"tvs-heatmap-header",style:{gridTemplateColumns:"repeat(4, 10px)"}},Array.from({length:4},(c,n)=>r("span",{key:n,className:"tvs-heatmap-header__label"},""))),r("div",{role:"grid",className:"tvs-heatmap-grid",style:{gridTemplateColumns:"repeat(4, 10px)"}},Array.from({length:4*7},(c,n)=>r("button",{key:n,className:"tvs-heatmap__cell lv-0",role:"gridcell",title:"No activity","aria-label":"No activity",tabIndex:0}))),r("div",{className:"tvs-text-muted"},"No data"));let v=new Date(P[0]+"T00:00:00Z"),C=new Date(P[P.length-1]+"T00:00:00Z"),O=(v.getUTCDay()+6)%7,F=new Date(v);F.setUTCDate(v.getUTCDate()-O);let f=[];for(let t=new Date(F);t<=C;t.setUTCDate(t.getUTCDate()+1)){let i=t.toISOString().slice(0,10);f.push({iso:i,weekday:(t.getUTCDay()+6)%7,date:new Date(t)})}let p=[];for(let t=0;t<f.length;t+=7)p.push(f.slice(t,t+7));let w=D.map(t=>t.count),E=Math.max(1,...w);u(()=>{let t=s.current;if(!t)return;function i(o){let l=document.activeElement;if(!l||!l.dataset||!l.dataset.idx)return;let N=parseInt(l.dataset.idx,10),_=null;if(o.key==="ArrowRight"?_=N+7:o.key==="ArrowLeft"?_=N-7:o.key==="ArrowDown"?_=N+1:o.key==="ArrowUp"&&(_=N-1),_!=null){let I=t.querySelector('[data-idx="'+_+'"]');I&&(I.focus(),o.preventDefault())}}t.addEventListener("keydown",i);let c=t.getBoundingClientRect(),n=t.querySelectorAll('.tvs-heatmap__cell[data-row="0"]');b.current=Array.from(n).map(o=>{let l=o.getBoundingClientRect();return l.left-c.left+l.width/2});function a(o){let l=$.current;if(!l)return;let N=b.current[o];N!=null&&(l.style.left=N+"px",l.style.display="block")}function m(){let o=$.current;o&&(o.style.display="none")}function g(o){let l=L.current;if(!l||!o)return;let N=o.getBoundingClientRect(),_=t.getBoundingClientRect(),I=o.getAttribute("data-date"),Z=parseInt(o.getAttribute("data-count")||"0",10);l.textContent=`${I}: ${Z}`,l.style.left=N.left-_.left+N.width/2+"px",l.style.top=N.top-_.top-8+"px",l.style.display="block",a(parseInt(o.getAttribute("data-col"),10)||0)}function T(){let o=L.current;o&&(o.style.display="none")}function A(o){let l=o.target&&o.target.closest&&o.target.closest(".tvs-heatmap__cell");if(l){g(l);return}T();let N=o.clientX-t.getBoundingClientRect().left;if(b.current&&b.current.length){let _=0,I=1/0;b.current.forEach((Z,Y)=>{let J=Math.abs(Z-N);J<I&&(I=J,_=Y)}),a(_)}}function j(){m(),T()}function V(o){let l=o.target&&o.target.closest(".tvs-heatmap__cell");l&&g(l)}function z(){T(),m()}return t.addEventListener("mousemove",A),t.addEventListener("mouseleave",j),t.addEventListener("focusin",V),t.addEventListener("focusout",z),()=>{t.removeEventListener("keydown",i),t.removeEventListener("mousemove",A),t.removeEventListener("mouseleave",j),t.removeEventListener("focusin",V),t.removeEventListener("focusout",z)}},[p.length]);let S=p.map((t,i)=>{let c=t[0]&&t[0].date;return c&&c.getUTCDate()<=7?c.toLocaleString(void 0,{month:"short"}):""});return r("div",{className:"tvs-heatmap-wrap tvs-heatmap--interactive"},r("div",{className:"tvs-heatmap-header",style:{gridTemplateColumns:`repeat(${p.length}, 10px)`}},S.map((t,i)=>r("span",{key:i,className:"tvs-heatmap-header__label"},t))),r("div",{ref:s,role:"grid",className:"tvs-heatmap-grid",style:{gridTemplateColumns:`repeat(${p.length}, 10px)`}},[...p.flatMap((t,i)=>t.map((c,n)=>{let a=G.get(c.iso)||0,m=E?Math.ceil(a/E*4):0,g=`${c.iso}: ${a} activity${a===1?"":"ies"}`,T=i*7+n;return r("button",{key:`${i}:${n}`,className:`tvs-heatmap__cell lv-${m}`,title:g,"aria-label":g,role:"gridcell",tabIndex:0,"data-idx":T,"data-col":i,"data-row":n,"data-date":c.iso,"data-count":a})})),r("div",{ref:$,className:"tvs-heatmap__guide","aria-hidden":"true"}),r("div",{ref:L,className:"tvs-heatmap__tooltip",style:{display:"none"}})]))}function vt({React:y,title:d,type:r,routeId:x,showDistance:k,showPace:u,showCumulative:M}){let{createElement:s,useEffect:$,useState:L}=y,[b,D]=L(null),[G,P]=L(null),[v,C]=L(180),O=!!window.TVS_SETTINGS?.user;return $(()=>{if(!O){let p=Array.from({length:v>90?180:v},(w,E)=>{let S=new Date;return S.setDate(S.getDate()-(v>90?180:v)+E),{date:S.toISOString().slice(0,10),count:Math.floor(Math.random()*3),distance_km:Math.random()*10,avg_pace_s_per_km:300+Math.random()*120}});D({items:p});return}let F=!1;async function f(){try{let p=window.TVS_SETTINGS&&TVS_SETTINGS.restRoot||"/wp-json/",w=new URLSearchParams;x&&w.set("route_id",String(x)),w.set("days",String(v));let E=`${p.replace(/\/$/,"")}/tvs/v1/activities/aggregate?${w.toString()}`,S=await fetch(E,{headers:{"X-WP-Nonce":window.TVS_SETTINGS&&TVS_SETTINGS.nonce||""}});if(!S.ok)throw new Error("HTTP "+S.status);let t=await S.json();F||D(t)}catch(p){F||P(p.message||"Failed")}}return f(),()=>{F=!0}},[x,v,O]),O?s("div",{className:"tvs-panel"},s("h3",{className:"tvs-activities-title"},d||"Activity Heatmap"),r==="sparkline"?s("div",{className:"tvs-mini-seg"},s("button",{className:v===7?"is-active":"",onClick:()=>C(7)},"1w"),s("button",{className:v===30?"is-active":"",onClick:()=>C(30)},"1m"),s("button",{className:v===365?"is-active":"",onClick:()=>C(365)},"1y")):null,!b&&!G?s("div",{className:"tvs-text-muted",style:{marginBottom:"0.5rem"}},"Loading\u2026"):null,G?s("div",{className:"tvs-text-danger"},String(G)):null,b?r==="calendar"?s(it,{React:y,data:b}):s(rt,{React:y,data:b,showDistance:k,showPace:u,showCumulative:M}):null):s("div",{className:"tvs-panel"},s("h3",{className:"tvs-activities-title"},d||"Activity Heatmap"),r==="sparkline"?s("div",{className:"tvs-mini-seg"},s("button",{className:v===7?"is-active":"",onClick:()=>C(7),disabled:!0},"1w"),s("button",{className:v===30?"is-active":"",onClick:()=>C(30),disabled:!0},"1m"),s("button",{className:v===365?"is-active":"",onClick:()=>C(365),disabled:!0},"1y")):null,s("div",{style:{opacity:.5,pointerEvents:"none"}},r==="calendar"?s(it,{React:y,data:b}):s(rt,{React:y,data:b,showDistance:k,showPace:u,showCumulative:M})),s("div",{className:"tvs-activities-footer"},s("div",{className:"tvs-text-muted",style:{marginBottom:"0.5rem"}},"Sign in to see your activity heatmap."),s("div",null,s("a",{href:"/login",className:"tvs-link",style:{marginRight:12}},"Log in"),s("a",{href:"/register",className:"tvs-link"},"Register"))))}function ct(){document.querySelectorAll(".tvs-activity-heatmap-block").forEach((d,r)=>{if(d.__tvsMounted)return;let x=d.getAttribute("data-title")||"",k=d.getAttribute("data-type")||"sparkline",u=parseInt(d.getAttribute("data-route-id")||"0",10)||0,M=d.getAttribute("data-show-distance")==="1",s=d.getAttribute("data-show-pace")==="1",$=d.getAttribute("data-show-cumulative")==="1";ot(vt,{React:Q,title:x,type:k,routeId:u,showDistance:M,showPace:s,showCumulative:$},d),d.__tvsMounted=!0})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",ct):ct();})();
//# sourceMappingURL=tvs-block-activity-heatmap.js.map
