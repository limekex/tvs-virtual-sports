(()=>{var ht=new URLSearchParams(location.search).get("tvsdebug")==="1"||window.TVS_DEBUG===!0||localStorage.getItem("tvsDev")==="1";function et(...y){console.error("[TVS]",...y)}var at=!!(window.React&&window.ReactDOM),ut=!!(window.wp&&window.wp.element),W=ut?window.wp.element:{},Q=at?window.React:W||{},P=at?window.ReactDOM:W||null,nt=new WeakMap,dt=P&&typeof P.createRoot=="function"||W&&typeof W.createRoot=="function";function ot(y,d,o){try{let v=nt.get(o);if(v&&typeof v.unmount=="function"?(v.unmount(),nt.delete(o)):P&&typeof P.unmountComponentAtNode=="function"&&P.unmountComponentAtNode(o),dt){let N=(P&&P.createRoot||W&&W.createRoot)(o);nt.set(o,N),N.render(Q.createElement(y,d));return}let E=P&&P.render||W&&W.render;if(E){E(Q.createElement(y,d),o);return}et("Ingen render-funksjon tilgjengelig.")}catch(v){et("Mount feilet:",v)}}function mt({React:y,data:d,showDistance:o,showPace:v,showCumulative:E}){let{createElement:l,useEffect:N,useRef:m,useState:D}=y,M=m(null),T=m(null),A=m(null),U=m(null),$=m(null),b=m([]),B=m([]),[V,q]=D(!1);return N(()=>{function f(){let x=T.current,_=M.current;if(!x||!_)return;let F=_.getBoundingClientRect(),t=Math.max(40,Math.floor(F.width)),r=Math.max(40,Math.floor(F.height)),c=Math.min(2,window.devicePixelRatio||1);x.width=Math.floor(t*c),x.height=Math.floor(r*c),x.style.width=t+"px",x.style.height=r+"px";let n=x.getContext("2d");n.setTransform(1,0,0,1,0,0),n.scale(c,c),n.clearRect(0,0,t,r);let s=d&&d.items?d.items.slice().sort((e,h)=>e.date<h.date?-1:e.date>h.date?1:0):null;B.current=s||[];let u=s?s.map(e=>e.count||0):Array.from({length:20},()=>Math.floor(Math.random()*5)),p=s?s.map(e=>e.distance_km||0):Array(u.length).fill(0),S=s?s.map(e=>typeof e.avg_pace_s_per_km=="number"?e.avg_pace_s_per_km:0):Array(u.length).fill(0);function L(e,h=7){if(!e||e.length===0)return e;let I=new Array(e.length).fill(0),O=Math.floor(h/2);for(let R=0;R<e.length;R++){let K=0,H=0;for(let X=R-O;X<=R+O;X++)X>=0&&X<e.length&&(K+=e[X],H++);I[R]=H?K/H:e[R]}return I}let j=L(p),G=L(S),z=Math.max(1,...u),a=Math.max(1,...j),i=Math.max(1,...G),k=Math.min(...G.filter(e=>e>0))||0;function w(e){return e.map((h,I)=>{let O=Math.max(1,e.length-1),R=I/O*(t-4)+2,K=(1-h/Math.max(1,Math.max(...e)))*(r-6)+3,H=s&&s[I]?s[I].date:null;return{x:R,y:K,v:h,i:I,date:H}})}let C=w(u),Z=w(j);function Y(e){let h=k,I=Math.max(h+1,i);return e.map((O,R)=>{let K=Math.max(1,e.length-1),H=R/K*(t-4)+2,it=(O-h)/(I-h)*(r-6)+3,lt=s&&s[R]?s[R].date:null;return{x:H,y:it,v:O,i:R,date:lt}})}let J=Y(G),st=0,tt=p.map(e=>(st+=e,st)),ct=w(tt);b.current=C,n.strokeStyle="#0ea5e9",n.lineWidth=2,n.beginPath(),C.forEach((e,h)=>{h===0?n.moveTo(e.x,e.y):n.lineTo(e.x,e.y)}),n.stroke(),o&&s&&a>0&&(n.strokeStyle="#16a34a",n.lineWidth=2,n.beginPath(),Z.forEach((e,h)=>{h===0?n.moveTo(e.x,e.y):n.lineTo(e.x,e.y)}),n.stroke()),v&&s&&i>0&&(n.strokeStyle="#f59e0b",n.setLineDash([4,3]),n.beginPath(),J.forEach((e,h)=>{h===0?n.moveTo(e.x,e.y):n.lineTo(e.x,e.y)}),n.stroke(),n.setLineDash([])),E&&s&&tt[tt.length-1]>0&&(n.strokeStyle="#8b5cf6",n.lineWidth=2,n.beginPath(),ct.forEach((e,h)=>{h===0?n.moveTo(e.x,e.y):n.lineTo(e.x,e.y)}),n.stroke()),q(!0)}f();let g=()=>f();return window.addEventListener("resize",g),()=>window.removeEventListener("resize",g)},[d]),N(()=>{let f=M.current;if(!f)return;let g=A.current,x=U.current,_=$.current;function F(s){let u=f.getBoundingClientRect(),p=s-u.left,S=0,L=1/0;return b.current.forEach((j,G)=>{let z=Math.abs(j.x-p);z<L&&(S=G,L=z)}),S}function t(s){let u=b.current[s];if(!u)return;let p=B.current[s];g.style.left=u.x+"px",g.style.display="block",x.style.left=u.x+"px",x.style.top=u.y+"px",x.style.display="block";let S=p&&typeof p.distance_km=="number"?`, ${p.distance_km.toFixed(1)} km`:"",L=p&&typeof p.avg_pace_s_per_km=="number"?`, ${new Date(p.avg_pace_s_per_km*1e3).toISOString().substr(14,5)}/km`:"";_.textContent=u.date?`${u.date}: ${u.v}${S}${L}`:String(u.v),_.style.left=u.x+"px",_.style.top=u.y-8+"px",_.style.display="block"}function r(){g.style.display="none",x.style.display="none",_.style.display="none"}function c(s){let u=s.touches&&s.touches[0]?s.touches[0]:s,p=F(u.clientX);t(p)}function n(){r()}return f.addEventListener("mousemove",c),f.addEventListener("mouseleave",n),f.addEventListener("touchstart",c,{passive:!0}),f.addEventListener("touchmove",c,{passive:!0}),f.addEventListener("touchend",n),()=>{f.removeEventListener("mousemove",c),f.removeEventListener("mouseleave",n),f.removeEventListener("touchstart",c),f.removeEventListener("touchmove",c),f.removeEventListener("touchend",n)}},[]),l("div",{ref:M,className:"tvs-sparkline"},l("canvas",{ref:T,width:220,height:40}),l("div",{ref:A,className:"tvs-sparkline__guide",style:{display:"none"},"aria-hidden":"true"}),l("div",{ref:U,className:"tvs-sparkline__dot",style:{display:"none"},"aria-hidden":"true"}),l("div",{ref:$,className:"tvs-sparkline__tooltip",style:{display:"none"}}),V?l("div",{className:"tvs-spark-legend","aria-hidden":"true"},l("span",{className:"tvs-spark-legend__swatch",style:{background:"#0ea5e9"}}),l("span",null,"Count"),o?l(y.Fragment,null,l("span",{className:"tvs-spark-legend__swatch",style:{background:"#16a34a"}}),l("span",null,"KM")):null,v?l(y.Fragment,null,l("span",{className:"tvs-spark-legend__swatch",style:{background:"#f59e0b"}}),l("span",null,"Pace")):null,E?l(y.Fragment,null,l("span",{className:"tvs-spark-legend__swatch",style:{background:"#8b5cf6"}}),l("span",null,"Cum KM")):null):null)}function ft({React:y,data:d}){let{createElement:o,useMemo:v,useRef:E,useEffect:l,useState:N}=y,m=E(null),D=E(null),M=E(null),T=E([]),A=v(()=>(d&&d.items||[]).slice().sort((r,c)=>r.date<c.date?-1:r.date>c.date?1:0),[d]),U=v(()=>{let t=new Map;return A.forEach(r=>t.set(r.date,r.count)),t},[A]),$=A.map(t=>t.date);if($.length===0)return o("div",{className:"tvs-heatmap-wrap tvs-heatmap--interactive"},o("div",{className:"tvs-heatmap-header",style:{gridTemplateColumns:"repeat(4, 10px)"}},Array.from({length:4},(c,n)=>o("span",{key:n,className:"tvs-heatmap-header__label"},""))),o("div",{role:"grid",className:"tvs-heatmap-grid",style:{gridTemplateColumns:"repeat(4, 10px)"}},Array.from({length:4*7},(c,n)=>o("button",{key:n,className:"tvs-heatmap__cell lv-0",role:"gridcell",title:"No activity","aria-label":"No activity",tabIndex:0}))),o("div",{className:"tvs-text-muted"},"No data"));let b=new Date($[0]+"T00:00:00Z"),B=new Date($[$.length-1]+"T00:00:00Z"),V=(b.getUTCDay()+6)%7,q=new Date(b);q.setUTCDate(b.getUTCDate()-V);let f=[];for(let t=new Date(q);t<=B;t.setUTCDate(t.getUTCDate()+1)){let r=t.toISOString().slice(0,10);f.push({iso:r,weekday:(t.getUTCDay()+6)%7,date:new Date(t)})}let g=[];for(let t=0;t<f.length;t+=7)g.push(f.slice(t,t+7));let x=A.map(t=>t.count),_=Math.max(1,...x);l(()=>{let t=m.current;if(!t)return;function r(a){let i=document.activeElement;if(!i||!i.dataset||!i.dataset.idx)return;let k=parseInt(i.dataset.idx,10),w=null;if(a.key==="ArrowRight"?w=k+7:a.key==="ArrowLeft"?w=k-7:a.key==="ArrowDown"?w=k+1:a.key==="ArrowUp"&&(w=k-1),w!=null){let C=t.querySelector('[data-idx="'+w+'"]');C&&(C.focus(),a.preventDefault())}}t.addEventListener("keydown",r);let c=t.getBoundingClientRect(),n=t.querySelectorAll('.tvs-heatmap__cell[data-row="0"]');T.current=Array.from(n).map(a=>{let i=a.getBoundingClientRect();return i.left-c.left+i.width/2});function s(a){let i=D.current;if(!i)return;let k=T.current[a];k!=null&&(i.style.left=k+"px",i.style.display="block")}function u(){let a=D.current;a&&(a.style.display="none")}function p(a){let i=M.current;if(!i||!a)return;let k=a.getBoundingClientRect(),w=t.getBoundingClientRect(),C=a.getAttribute("data-date"),Z=parseInt(a.getAttribute("data-count")||"0",10);i.textContent=`${C}: ${Z}`,i.style.left=k.left-w.left+k.width/2+"px",i.style.top=k.top-w.top-8+"px",i.style.display="block",s(parseInt(a.getAttribute("data-col"),10)||0)}function S(){let a=M.current;a&&(a.style.display="none")}function L(a){let i=a.target&&a.target.closest&&a.target.closest(".tvs-heatmap__cell");if(i){p(i);return}S();let k=a.clientX-t.getBoundingClientRect().left;if(T.current&&T.current.length){let w=0,C=1/0;T.current.forEach((Z,Y)=>{let J=Math.abs(Z-k);J<C&&(C=J,w=Y)}),s(w)}}function j(){u(),S()}function G(a){let i=a.target&&a.target.closest(".tvs-heatmap__cell");i&&p(i)}function z(){S(),u()}return t.addEventListener("mousemove",L),t.addEventListener("mouseleave",j),t.addEventListener("focusin",G),t.addEventListener("focusout",z),()=>{t.removeEventListener("keydown",r),t.removeEventListener("mousemove",L),t.removeEventListener("mouseleave",j),t.removeEventListener("focusin",G),t.removeEventListener("focusout",z)}},[g.length]);let F=g.map((t,r)=>{let c=t[0]&&t[0].date;return c&&c.getUTCDate()<=7?c.toLocaleString(void 0,{month:"short"}):""});return o("div",{className:"tvs-heatmap-wrap tvs-heatmap--interactive"},o("div",{className:"tvs-heatmap-header",style:{gridTemplateColumns:`repeat(${g.length}, 10px)`}},F.map((t,r)=>o("span",{key:r,className:"tvs-heatmap-header__label"},t))),o("div",{ref:m,role:"grid",className:"tvs-heatmap-grid",style:{gridTemplateColumns:`repeat(${g.length}, 10px)`}},[...g.flatMap((t,r)=>t.map((c,n)=>{let s=U.get(c.iso)||0,u=_?Math.ceil(s/_*4):0,p=`${c.iso}: ${s} activity${s===1?"":"ies"}`,S=r*7+n;return o("button",{key:`${r}:${n}`,className:`tvs-heatmap__cell lv-${u}`,title:p,"aria-label":p,role:"gridcell",tabIndex:0,"data-idx":S,"data-col":r,"data-row":n,"data-date":c.iso,"data-count":s})})),o("div",{ref:D,className:"tvs-heatmap__guide","aria-hidden":"true"}),o("div",{ref:M,className:"tvs-heatmap__tooltip",style:{display:"none"}})]))}function pt({React:y,title:d,type:o,routeId:v,showDistance:E,showPace:l,showCumulative:N}){let{createElement:m,useEffect:D,useState:M}=y,[T,A]=M(null),[U,$]=M(null),[b,B]=M(180);return D(()=>{let V=!1;async function q(){try{let f=window.TVS_SETTINGS&&TVS_SETTINGS.restRoot||"/wp-json/",g=new URLSearchParams;v&&g.set("route_id",String(v)),g.set("days",String(b));let x=`${f.replace(/\/$/,"")}/tvs/v1/activities/aggregate?${g.toString()}`,_=await fetch(x,{headers:{"X-WP-Nonce":window.TVS_SETTINGS&&TVS_SETTINGS.nonce||""}});if(!_.ok)throw new Error("HTTP "+_.status);let F=await _.json();V||A(F)}catch(f){V||$(f.message||"Failed")}}return q(),()=>{V=!0}},[v,b]),m("div",{className:"tvs-panel"},m("h3",{className:"tvs-activities-title"},d||"Activity Heatmap"),o==="sparkline"?m("div",{className:"tvs-mini-seg"},m("button",{className:b===7?"is-active":"",onClick:()=>B(7)},"1w"),m("button",{className:b===30?"is-active":"",onClick:()=>B(30)},"1m"),m("button",{className:b===365?"is-active":"",onClick:()=>B(365)},"1y")):null,!T&&!U?m("div",{className:"tvs-text-muted",style:{marginBottom:"0.5rem"}},"Loading\u2026"):null,U?m("div",{className:"tvs-text-danger"},String(U)):null,o==="calendar"?m(ft,{React:y,data:T}):m(mt,{React:y,data:T,showDistance:E,showPace:l,showCumulative:N}))}function rt(){document.querySelectorAll(".tvs-activity-heatmap-block").forEach((d,o)=>{if(d.__tvsMounted)return;let v=d.getAttribute("data-title")||"",E=d.getAttribute("data-type")||"sparkline",l=parseInt(d.getAttribute("data-route-id")||"0",10)||0,N=d.getAttribute("data-show-distance")==="1",m=d.getAttribute("data-show-pace")==="1",D=d.getAttribute("data-show-cumulative")==="1";ot(pt,{React:Q,title:v,type:E,routeId:l,showDistance:N,showPace:m,showCumulative:D},d),d.__tvsMounted=!0})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",rt):rt();})();
//# sourceMappingURL=tvs-block-activity-heatmap.js.map
