(()=>{var{createElement:e,useState:y,useEffect:X,useRef:K}=window.React,{createRoot:Q}=window.ReactDOM;var H=t=>{let o=document.createElement("textarea");return o.innerHTML=t,o.value},U=({onSelect:t,userId:o,activityType:r,excludeId:c,placeholder:p})=>{let[N,f]=y(""),[L,M]=y([]),[w,I]=y(!1),[k,C]=y(!1),x=K(null);X(()=>{let a=b=>{x.current&&!x.current.contains(b.target)&&I(!1)};return document.addEventListener("mousedown",a),()=>document.removeEventListener("mousedown",a)},[]),X(()=>{if(N.length<2){M([]);return}let a=setTimeout(()=>V(N),300);return()=>clearTimeout(a)},[N,r,o]);let V=async a=>{C(!0);try{let b=await fetch(`${TVS_SETTINGS.restRoot}tvs/v1/activities/user/${o}?per_page=50`,{headers:{"X-WP-Nonce":TVS_SETTINGS.nonce}});if(!b.ok)throw new Error("Failed to search activities");let B=await b.json(),F=m=>{let h=document.createElement("textarea");return h.innerHTML=m,h.value},g=(B.activities||[]).filter(m=>{let h=!r||m.activity_type===r,T=F(m.title||"").toLowerCase(),W=(m.activity_type||"").toLowerCase(),R=a.toLowerCase(),O=T.includes(R)||W.includes(R),j=R.split(/\s+/).filter(s=>s.length>0),i=0;j.forEach(s=>{T.includes(s)&&i++,W.includes(s)&&i++}),m._relevance=O?1e3+i:i;let $=i>0,l=!c||m.id!==c,A=m.duration_s>0;return h&&$&&l&&A});g.sort((m,h)=>h._relevance!==m._relevance?h._relevance-m._relevance:new Date(h.date)-new Date(m.date)),M(g),I(g.length>0)}catch(b){console.error("Search error:",b)}finally{C(!1)}},S=a=>{t(a),f(H(a.title)),I(!1)};return e("div",{className:"tvs-activity-search",ref:x},[e("input",{key:"search-input",type:"text",className:"tvs-activity-search__input",placeholder:p||"Search activities...",value:N,onChange:a=>f(a.target.value),onFocus:()=>L.length>0&&I(!0)}),k&&e("span",{key:"loading",className:"tvs-activity-search__loading"},"\u{1F50D}"),w&&L.length>0&&e("ul",{key:"results-list",className:"tvs-activity-search__results"},L.map(a=>e("li",{key:a.id,className:"tvs-activity-search__result",onClick:()=>S(a)},[e("div",{key:"title",className:"tvs-activity-search__result-title"},H(a.title)),e("div",{key:"meta",className:"tvs-activity-search__result-meta"},`${a.activity_type} \u2022 ${new Date(a.date).toLocaleDateString()} \u2022 ${P(a.duration_s)}`)])))])},Z=({currentMode:t,onChange:o})=>e("div",{className:"tvs-mode-switch"},[e("button",{key:"manual",className:`tvs-mode-switch__btn ${t==="manual"?"tvs-mode-switch__btn--active":""}`,onClick:()=>o("manual")},"\u2699\uFE0F Manual"),e("button",{key:"vs-best",className:`tvs-mode-switch__btn ${t==="vs-best"?"tvs-mode-switch__btn--active":""}`,onClick:()=>o("vs-best")},"\u{1F3C6} Latest vs Best")]),ee=({userId:t,mode:o,activityId1:r,activityId2:c,routeId:p,title:N})=>{let[f,L]=y(o||"vs-best"),[M,w]=y(null),[I,k]=y(null),[C,x]=y(!1),[V,S]=y(null),[a,b]=y(null),[B,F]=y(null),[g,m]=y("all"),[h,Y]=y([]),T=!!p;X(()=>{f==="manual"?a&&B?(w(a),k(B),S(null)):(w(null),k(null)):W()},[f,a,B,p,t,g]);let W=async()=>{try{x(!0),S(null),T?await O():f==="vs-best"&&await R()}catch(i){S(i.message),w(null),k(null)}finally{x(!1)}},R=async()=>{let i=await fetch(`${TVS_SETTINGS.restRoot}tvs/v1/activities/user/${t}?per_page=100`,{headers:{"X-WP-Nonce":TVS_SETTINGS.nonce}});if(!i.ok)throw new Error("Failed to fetch activities");let l=((await i.json()).activities||[]).filter(n=>n.duration_s>0);if(l.length===0)throw new Error("No activities found");let A=[...new Set(l.map(n=>n.activity_type))].sort();if(Y(A),g!=="all"&&(l=l.filter(n=>n.activity_type===g),l.length===0))throw new Error(`No ${g} activities found`);let v=[...l].sort((n,d)=>new Date(d.date)-new Date(n.date))[0],D=l.filter(n=>n.activity_type===v.activity_type&&n.id!==v.id);v.route_id&&T&&(D=D.filter(n=>n.route_id===v.route_id));let _;if(v.activity_type==="Workout"?_=[...D].sort((d,u)=>u.duration_s-d.duration_s)[0]:v.activity_type==="Swim"?_=[...D.filter(u=>u.laps>0)].sort((u,E)=>{let G=u.duration_s/u.laps,q=E.duration_s/E.laps;return G-q})[0]:_=[...D.filter(u=>u.distance_m>0&&u.duration_s>0)].sort((u,E)=>{let G=u.distance_m/1e3/(u.duration_s/3600);return E.distance_m/1e3/(E.duration_s/3600)-G})[0],!_){w(v),k(v),S("\u{1F3C6} This is your best (or only) activity of this type!");return}w(v),k(_)},O=async()=>{if(!p)throw new Error("Route ID required");let i=await fetch(`${TVS_SETTINGS.restRoot}tvs/v1/activities/user/${t}?route_id=${p}&per_page=50`,{headers:{"X-WP-Nonce":TVS_SETTINGS.nonce}});if(!i.ok)throw new Error("Failed to fetch route activities");let l=((await i.json()).activities||[]).filter(d=>d.duration_s>0);if(l.length===0)throw new Error("No activities on this route yet");let s=[...l].sort((d,u)=>new Date(u.date)-new Date(d.date))[0];if(l.length<2){w(s),k(s),S("\u{1F3C6} This is your only activity on this route!");return}let n=[...l.filter(d=>d.id!==s.id).filter(d=>d.distance_m>0&&d.duration_s>0)].sort((d,u)=>{let E=d.distance_m/1e3/(d.duration_s/3600);return u.distance_m/1e3/(u.duration_s/3600)-E})[0];if(!n){w(s),k(s),S("\u{1F3C6} This is your best activity on this route!");return}w(s),k(n)};if(C)return e("div",{className:"tvs-loading"},e("div",{className:"tvs-spinner"}),e("p",null,"Loading comparison..."));return e("div",{className:"tvs-comparison"},[e("h2",{key:"title",className:"tvs-comparison__title"},N||"Activity Comparison"),!T&&e(Z,{key:"mode-switch",currentMode:f,onChange:i=>{L(i),S(null),b(null),F(null)}}),f==="vs-best"&&!T&&h.length>0&&e("div",{key:"type-filter",className:"tvs-comparison__type-filter"},[e("label",{key:"label"},"Activity Type:"),e("select",{key:"select",value:g,onChange:i=>m(i.target.value),className:"tvs-comparison__type-select"},[e("option",{key:"all",value:"all"},"All Types"),...h.map(i=>e("option",{key:i,value:i},i))])]),T&&e("div",{key:"route-badge",className:"tvs-comparison__route-badge"},"\u{1F4CD} Your performance on this route"),f==="manual"&&!T&&e("div",{key:"manual-controls",className:"tvs-comparison__manual-controls"},[e("p",{key:"instructions",className:"tvs-comparison__instructions"},"Search by activity title or route name. Activities will be filtered by the same type for meaningful comparisons."),e("div",{key:"search-1",className:"tvs-comparison__search-group"},[e("label",{key:"label-1"},"Activity 1:"),e(U,{key:"dropdown-1",userId:t,activityType:a?.activity_type,excludeId:B?.id,onSelect:b,placeholder:"Type at least 2 characters to search..."})]),e("div",{key:"search-2",className:"tvs-comparison__search-group"},[e("label",{key:"label-2"},"Activity 2:"),e(U,{key:"dropdown-2",userId:t,activityType:a?.activity_type,excludeId:a?.id,onSelect:F,placeholder:a?"Search for second activity...":"Select first activity first"}),!a&&e("p",{key:"first-activity-hint",className:"tvs-comparison__hint"},"\u{1F4A1} Select an activity above first")]),a&&B&&a.activity_type!==B.activity_type&&e("div",{key:"type-mismatch-warning",className:"tvs-comparison__warning"},"\u26A0\uFE0F Comparing different activity types is not meaningful")]),V&&!I&&e("div",{key:"info",className:"tvs-comparison__info"},e("p",null,"\u2139\uFE0F ",V)),f==="manual"&&!M&&!C&&e("div",{key:"empty-state",className:"tvs-empty-state"},e("p",null,"\u{1F446} Select two activities above to compare")),M&&I&&e("div",{key:"comparison-table"},j(M,I))]);function j(i,$){let l=i.activity_type,A;return l==="Swim"?A=[{key:"laps",label:"Laps",format:s=>s||"N/A",lowerIsBetter:!1},{key:"duration_s",label:"Duration",format:P,lowerIsBetter:!0},{key:"pace_per_lap",label:"Pace per Lap",format:P,lowerIsBetter:!0,computed:!0},{key:"distance_m",label:"Distance",format:J,lowerIsBetter:!1},{key:"rating",label:"Rating",format:s=>s?`${s}/10`:"N/A",lowerIsBetter:!1}]:l==="Workout"?A=[{key:"duration_s",label:"Duration",format:P,lowerIsBetter:!1},{key:"sets",label:"Sets",format:s=>s||"N/A",lowerIsBetter:!1},{key:"reps",label:"Reps",format:s=>s||"N/A",lowerIsBetter:!1},{key:"weight",label:"Weight (kg)",format:s=>s?`${s} kg`:"N/A",lowerIsBetter:!1},{key:"rating",label:"Rating",format:s=>s?`${s}/10`:"N/A",lowerIsBetter:!1}]:A=[{key:"distance_m",label:"Distance",format:J,lowerIsBetter:!1},{key:"duration_s",label:"Duration",format:P,lowerIsBetter:!0},{key:"pace",label:"Pace",format:se,lowerIsBetter:!0,computed:!0},{key:"speed",label:"Speed",format:ae,lowerIsBetter:!1,computed:!0},{key:"rating",label:"Rating",format:s=>s?`${s}/10`:"N/A",lowerIsBetter:!1}],e("div",{className:"tvs-comparison__container"},[e("div",{key:"header-row",className:"tvs-comparison__header-row"},[e("div",{key:"label-header",className:"tvs-comparison__header-label"},"Metric"),e("div",{key:"activity1-header",className:"tvs-comparison__header-activity"},[e("div",{key:"title",className:"tvs-comparison__header-title"},H(i.title)),e("div",{key:"date",className:"tvs-comparison__header-date"},new Date(i.date).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}))]),e("div",{key:"diff-header",className:"tvs-comparison__header-diff"},"Change"),e("div",{key:"activity2-header",className:"tvs-comparison__header-activity"},[e("div",{key:"title",className:"tvs-comparison__header-title"},H($.title)),e("div",{key:"date",className:"tvs-comparison__header-date"},new Date($.date).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}))])]),e("div",{key:"metrics-table",className:"tvs-comparison__table"},A.map(s=>{let v=s.computed?z(i,s.key):i[s.key],D=s.computed?z($,s.key):$[s.key],_=te(v,D,s.lowerIsBetter);return e("div",{key:s.key,className:"tvs-comparison__row"},[e("div",{key:"label",className:"tvs-comparison__label"},s.label),e("div",{key:"val1",className:"tvs-comparison__value"},s.format(v)),e("div",{key:"diff",className:`tvs-comparison__difference tvs-comparison__difference--${_.type}`},_.icon?`${_.icon} ${_.text}`:_.text),e("div",{key:"val2",className:"tvs-comparison__value"},s.format(D))])}))])}};function z(t,o){if(o==="pace"){let r=t.distance_m/1e3,c=t.duration_s/60;return r>0?c/r:null}else if(o==="speed"){let r=t.distance_m/1e3,c=t.duration_s/3600;return c>0?r/c:null}else if(o==="pace_per_lap"){let r=t.laps||0;return r>0?t.duration_s/r:null}return null}function te(t,o,r){if(!t||!o)return{text:"N/A",type:"neutral",icon:null};let c=t-o,p=Math.abs(c/o*100);return p<.5?{text:"Same",type:"neutral",icon:"="}:(r?c<0:c>0)?{text:`${p.toFixed(1)}%`,type:"positive",icon:"\u25B2"}:{text:`${p.toFixed(1)}%`,type:"negative",icon:"\u25BC"}}function J(t){return t?`${(t/1e3).toFixed(2)} km`:"N/A"}function P(t){if(!t)return"N/A";let o=Math.floor(t/3600),r=Math.floor(t%3600/60),c=Math.floor(t%60);return o>0?`${o}:${String(r).padStart(2,"0")}:${String(c).padStart(2,"0")}`:`${r}:${String(c).padStart(2,"0")}`}function se(t){if(!t||t===1/0)return"N/A";let o=Math.floor(t),r=Math.round(t%1*60);return`${o}:${String(r).padStart(2,"0")} /km`}function ae(t){return t?`${t.toFixed(2)} km/h`:"N/A"}document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll(".tvs-comparison-block").forEach(t=>{let o=parseInt(t.dataset.userId)||0,r=t.dataset.mode||"vs-best",c=parseInt(t.dataset.activityId1)||0,p=parseInt(t.dataset.activityId2)||0,N=parseInt(t.dataset.routeId)||0,f=t.dataset.title||"Activity Comparison";Q(t).render(e(ee,{userId:o,mode:r,activityId1:c,activityId2:p,routeId:N,title:f}))})});})();
//# sourceMappingURL=tvs-block-activity-comparison.js.map
