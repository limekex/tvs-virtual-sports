{
  "version": 3,
  "sources": ["../../src/utils/debug.js", "../../src/utils/reactMount.js", "../../src/blocks/route-insights/view.js"],
  "sourcesContent": ["// Debug utilities for TVS app\nexport const DEBUG =\n  new URLSearchParams(location.search).get(\"tvsdebug\") === \"1\" ||\n  window.TVS_DEBUG === true ||\n  localStorage.getItem(\"tvsDev\") === \"1\";\n\nexport function log(...args) {\n  if (DEBUG) console.debug(\"[TVS]\", ...args);\n}\n\nexport function err(...args) {\n  console.error(\"[TVS]\", ...args);\n}\n", "// React mount helper paired to the active renderer\nimport { log, err } from './debug.js';\n\nconst hasWindowReact = !!(window.React && window.ReactDOM);\nconst hasWpElement = !!(window.wp && window.wp.element);\nconst wpEl = hasWpElement ? window.wp.element : {};\nconst React = hasWindowReact ? window.React : (wpEl || {});\nconst ReactDOM = hasWindowReact ? window.ReactDOM : (wpEl || null);\n\n// Track mounted roots to safely unmount/re-mount\nconst tvsRoots = new WeakMap();\nconst hasCreateRoot =\n  (ReactDOM && typeof ReactDOM.createRoot === 'function') ||\n  (wpEl && typeof wpEl.createRoot === 'function');\n\nexport function mountReact(Component, props, node) {\n  try {\n    const existingRoot = tvsRoots.get(node);\n    if (existingRoot && typeof existingRoot.unmount === 'function') {\n      existingRoot.unmount();\n      tvsRoots.delete(node);\n    } else if (ReactDOM && typeof ReactDOM.unmountComponentAtNode === 'function') {\n      ReactDOM.unmountComponentAtNode(node);\n    }\n\n    if (hasCreateRoot) {\n      const createRoot = (ReactDOM && ReactDOM.createRoot) || (wpEl && wpEl.createRoot);\n      const root = createRoot(node);\n      tvsRoots.set(node, root);\n      root.render(React.createElement(Component, props));\n      return;\n    }\n\n    const legacyRender = (ReactDOM && ReactDOM.render) || (wpEl && wpEl.render);\n    if (legacyRender) {\n      legacyRender(React.createElement(Component, props), node);\n      return;\n    }\n    err('Ingen render-funksjon tilgjengelig.');\n  } catch (e) {\n    err('Mount feilet:', e);\n  }\n}\n\nexport { React, ReactDOM, wpEl };\n", "import { mountReact, React } from '../../utils/reactMount.js';\n\nfunction fmtDuration(seconds){\n  const s = Math.max(0, Math.floor(seconds||0));\n  const h = Math.floor(s/3600);\n  const m = Math.floor((s%3600)/60);\n  const r = s%60;\n  if(h>0) return `${h}:${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`;\n  return `${m}:${String(r).padStart(2,'0')}`;\n}\n\nfunction ElevationSparkline({ React, gpxUrl }){\n  const { createElement: h, useEffect, useRef, useState } = React;\n  const canvasRef = useRef(null);\n  const [err, setErr] = useState(null);\n  useEffect(() => {\n    if(!gpxUrl) return;\n    let cancelled = false;\n    async function run(){\n      try{\n        const res = await fetch(gpxUrl, { credentials: 'same-origin' });\n        if(!res.ok) throw new Error('HTTP '+res.status);\n        let text = await res.text();\n        if(cancelled) return;\n        // Sanitize common GPX header/path issues\n        try{\n          // Replace accidental \"<xml\" (missing ?) with proper XML declaration\n          text = text.replace(/^\\s*<xml\\b/i, m => m.replace('<xml', '<?xml'));\n          // Unescape accidental literal \\n and \\t sequences\n          text = text.replace(/\\\\n/g, '\\n').replace(/\\\\t/g, '\\t');\n        }catch(_e){ /* noop */ }\n\n        const parser = new window.DOMParser();\n        const doc = parser.parseFromString(text, 'application/xml');\n        const hasParserError = doc.getElementsByTagName('parsererror').length > 0;\n        // Try namespace-agnostic query first, then namespace-aware\n        let eles = Array.from(doc.getElementsByTagName('ele'));\n        if(eles.length < 2){\n          try{\n            eles = Array.from(doc.getElementsByTagNameNS('*', 'ele'));\n          }catch(_e){ /* noop */ }\n        }\n\n        let vals = eles.map(node => parseFloat((node.textContent||'').trim()))\n          .filter(v => Number.isFinite(v));\n\n        // Fallback: regex extraction if XML parser failed or found too few samples\n        if(vals.length < 2){\n          const regex = /<ele>\\s*([+-]?\\d+(?:\\.\\d+)?)\\s*<\\/ele>/gi;\n          const out = [];\n          let m;\n          while((m = regex.exec(text))){\n            const v = parseFloat(m[1]);\n            if(Number.isFinite(v)) out.push(v);\n          }\n          if(out.length >= 2) vals = out;\n        }\n\n        const c = canvasRef.current; if(!c) return;\n        const ctx = c.getContext('2d');\n        const w = c.width = 260, hgt = c.height = 50;\n        ctx.clearRect(0,0,w,hgt);\n        if(vals.length < 2){\n          // Distinguish malformed vs genuinely missing samples\n          if(hasParserError){\n            setErr('Malformed GPX file');\n          }else{\n            // If file looks like GPX but has no <ele> values\n            setErr(/<gpx[\\s>]/i.test(text) ? 'No elevation samples in GPX' : 'No elevation data');\n          }\n          return;\n        }\n        const min = Math.min(...vals), max = Math.max(...vals);\n        const rng = Math.max(1, max - min);\n        ctx.strokeStyle = '#0ea5e9'; ctx.lineWidth = 2; ctx.beginPath();\n        vals.forEach((v, i) => {\n          const x = (i/(vals.length-1)) * (w-4) + 2;\n          const y = (1-((v-min)/rng)) * (hgt-6) + 3;\n          if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);\n        });\n        ctx.stroke();\n      }catch(e){ if(!cancelled) setErr(e.message||'Failed'); }\n    }\n    run();\n    return () => { cancelled = true; };\n  }, [gpxUrl]);\n  return h('div', null,\n    h('canvas', { ref: canvasRef, width: 260, height: 50, style: { maxWidth:'100%', display:'block' }}),\n    err ? h('div', { className: 'tvs-text-muted', style:{fontSize:'.85em'} }, String(err)) : null\n  );\n}\n\nfunction RouteInsights({ React, title, showElevation, showSurface, showEta, showMapsLink, routeId }){\n  const { createElement: h, useEffect, useState } = React;\n  const [data, setData] = useState(null);\n  const [err, setErr] = useState(null);\n  useEffect(() => {\n    let cancelled = false;\n    async function load(){\n      if(!routeId){ setErr('No route selected.'); return; }\n      try{\n        const root = (window.TVS_SETTINGS && TVS_SETTINGS.restRoot) || '/wp-json/';\n        const url = `${root.replace(/\\/$/,'')}/tvs/v1/routes/${encodeURIComponent(routeId)}/insights`;\n        const res = await fetch(url);\n        if(!res.ok) throw new Error('HTTP '+res.status);\n        const json = await res.json();\n        if(!cancelled) setData(json);\n      }catch(e){ if(!cancelled) setErr(e.message||'Failed'); }\n    }\n    load();\n    return () => { cancelled = true; };\n  }, [routeId]);\n\n  const items = [];\n  const meta = (data && data.meta) || {};\n  if(showElevation){\n    const dist = meta.distance_m ? `${(meta.distance_m/1000).toFixed(2)} km` : null;\n    const head = `Distance: ${dist || '\u2014'} \u2022 Elevation: ${meta.elevation_m?Math.round(meta.elevation_m)+' m':'\u2014'}`;\n    items.push(h('div', null, head, meta.gpx_url ? h(ElevationSparkline, { React, gpxUrl: meta.gpx_url }) : null));\n  }\n  if(showSurface){ items.push(`Surface: ${meta.surface || '\u2014'}`); }\n  if(showEta){\n    const eta = data && data.computed && data.computed.eta_s ? fmtDuration(data.computed.eta_s) : '\u2014';\n    items.push(`Estimated time: ${eta}`);\n  }\n  if(showMapsLink){\n    const href = data && data.maps_url;\n    items.push(href ? h('a', { href, target:'_blank', rel:'noopener noreferrer' }, 'Open in Google Maps (midpoint)') : 'Open in Google Maps (\u2014)');\n  }\n\n  return h('div', { className: 'tvs-panel' },\n    h('h3', { className: 'tvs-activities-title' }, title || 'Route Insights'),\n    (!data && !err) ? h('div', { className: 'tvs-text-muted' }, 'Loading\u2026') : null,\n    err ? h('div', { className: 'tvs-text-danger' }, String(err)) : null,\n    h('ul', { className: 'tvs-list' }, items.map((it,i) => h('li', { key:i }, it)))\n  );\n}\n\nfunction mountAll(){\n  const nodes = document.querySelectorAll('.tvs-route-insights-block');\n  nodes.forEach((node, idx) => {\n    if(node.__tvsMounted) return;\n    const title = node.getAttribute('data-title') || '';\n    const showElevation = node.getAttribute('data-show-elevation') === '1';\n    const showSurface   = node.getAttribute('data-show-surface') === '1';\n    const showEta       = node.getAttribute('data-show-eta') === '1';\n    const showMapsLink  = node.getAttribute('data-show-maps-link') === '1';\n    const routeId = parseInt(node.getAttribute('data-route-id')||'0',10) || 0;\n    mountReact(RouteInsights, { React, title, showElevation, showSurface, showEta, showMapsLink, routeId }, node);\n    node.__tvsMounted = true;\n  });\n}\n\nif(document.readyState === 'loading'){\n  document.addEventListener('DOMContentLoaded', mountAll);\n}else{ mountAll(); }\n"],
  "mappings": "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",
  "names": ["DEBUG", "err", "args", "hasWindowReact", "hasWpElement", "wpEl", "React", "ReactDOM", "tvsRoots", "hasCreateRoot", "mountReact", "Component", "props", "node", "existingRoot", "root", "legacyRender", "err", "e", "fmtDuration", "seconds", "s", "h", "m", "r", "ElevationSparkline", "React", "gpxUrl", "useEffect", "useRef", "useState", "canvasRef", "err", "setErr", "cancelled", "run", "res", "text", "doc", "hasParserError", "eles", "vals", "node", "v", "regex", "out", "c", "ctx", "w", "hgt", "min", "max", "rng", "i", "x", "y", "e", "RouteInsights", "title", "showElevation", "showSurface", "showEta", "showMapsLink", "routeId", "data", "setData", "load", "url", "json", "items", "meta", "head", "eta", "href", "it", "mountAll", "idx", "mountReact"]
}
