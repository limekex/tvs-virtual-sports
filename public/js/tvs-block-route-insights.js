(()=>{var V=new URLSearchParams(location.search).get("tvsdebug")==="1"||window.TVS_DEBUG===!0||localStorage.getItem("tvsDev")==="1";function k(...r){console.error("[TVS]",...r)}var D=!!(window.React&&window.ReactDOM),O=!!(window.wp&&window.wp.element),p=O?window.wp.element:{},T=D?window.React:p||{},g=D?window.ReactDOM:p||null,$=new WeakMap,C=g&&typeof g.createRoot=="function"||p&&typeof p.createRoot=="function";function F(r,t,e){try{let o=$.get(e);if(o&&typeof o.unmount=="function"?(o.unmount(),$.delete(e)):g&&typeof g.unmountComponentAtNode=="function"&&g.unmountComponentAtNode(e),C){let c=(g&&g.createRoot||p&&p.createRoot)(e);$.set(e,c),c.render(T.createElement(r,t));return}let i=g&&g.render||p&&p.render;if(i){i(T.createElement(r,t),e);return}k("Ingen render-funksjon tilgjengelig.")}catch(o){k("Mount feilet:",o)}}function j(r){let t=Math.max(0,Math.floor(r||0)),e=Math.floor(t/3600),o=Math.floor(t%3600/60),i=t%60;return e>0?`${e}:${String(o).padStart(2,"0")}:${String(i).padStart(2,"0")}`:`${o}:${String(i).padStart(2,"0")}`}function B({React:r,gpxUrl:t}){let{createElement:e,useEffect:o,useRef:i,useState:S}=r,c=i(null),[a,w]=S(null);return o(()=>{if(!t)return;let E=!1;async function l(){try{let v=await fetch(t,{credentials:"same-origin"});if(!v.ok)throw new Error("HTTP "+v.status);let u=await v.text();if(E)return;try{u=u.replace(/^\s*<xml\b/i,m=>m.replace("<xml","<?xml")),u=u.replace(/\\n/g,`
`).replace(/\\t/g,"	")}catch{}let f=new window.DOMParser().parseFromString(u,"application/xml"),d=f.getElementsByTagName("parsererror").length>0,n=Array.from(f.getElementsByTagName("ele"));if(n.length<2)try{n=Array.from(f.getElementsByTagNameNS("*","ele"))}catch{}let s=n.map(m=>parseFloat((m.textContent||"").trim())).filter(m=>Number.isFinite(m));if(s.length<2){let m=/<ele>\s*([+-]?\d+(?:\.\d+)?)\s*<\/ele>/gi,y=[],M;for(;M=m.exec(u);){let N=parseFloat(M[1]);Number.isFinite(N)&&y.push(N)}y.length>=2&&(s=y)}let x=c.current;if(!x)return;let h=x.getContext("2d"),R=x.width=260,_=x.height=50;if(h.clearRect(0,0,R,_),s.length<2){w(d?"Malformed GPX file":/<gpx[\s>]/i.test(u)?"No elevation samples in GPX":"No elevation data");return}let A=Math.min(...s),P=Math.max(...s),I=Math.max(1,P-A);h.strokeStyle="#0ea5e9",h.lineWidth=2,h.beginPath(),s.forEach((m,y)=>{let M=y/(s.length-1)*(R-4)+2,N=(1-(m-A)/I)*(_-6)+3;y===0?h.moveTo(M,N):h.lineTo(M,N)}),h.stroke()}catch(v){E||w(v.message||"Failed")}}return l(),()=>{E=!0}},[t]),e("div",null,e("canvas",{ref:c,width:260,height:50,style:{maxWidth:"100%",display:"block"}}),a?e("div",{className:"tvs-text-muted",style:{fontSize:".85em"}},String(a)):null)}function L({React:r,title:t,showElevation:e,showSurface:o,showEta:i,showMapsLink:S,routeId:c}){let{createElement:a,useEffect:w,useState:E}=r,[l,v]=E(null),[u,b]=E(null);w(()=>{let n=!1;async function s(){if(!c){b("No route selected.");return}try{let h=`${(window.TVS_SETTINGS&&TVS_SETTINGS.restRoot||"/wp-json/").replace(/\/$/,"")}/tvs/v1/routes/${encodeURIComponent(c)}/insights`,R=await fetch(h);if(!R.ok)throw new Error("HTTP "+R.status);let _=await R.json();n||v(_)}catch(x){n||b(x.message||"Failed")}}return s(),()=>{n=!0}},[c]);let f=[],d=l&&l.meta||{};if(e){let s=`Distance: ${(d.distance_m?`${(d.distance_m/1e3).toFixed(2)} km`:null)||"\u2014"} \u2022 Elevation: ${d.elevation_m?Math.round(d.elevation_m)+" m":"\u2014"}`;f.push(a("div",null,s,d.gpx_url?a(B,{React:r,gpxUrl:d.gpx_url}):null))}if(o&&f.push(`Surface: ${d.surface||"\u2014"}`),i){let n=l&&l.computed&&l.computed.eta_s?j(l.computed.eta_s):"\u2014";f.push(`Estimated time: ${n}`)}if(S){let n=l&&l.maps_url;f.push(n?a("a",{href:n,target:"_blank",rel:"noopener noreferrer"},"Open in Google Maps (midpoint)"):"Open in Google Maps (\u2014)")}return a("div",{className:"tvs-panel"},a("h3",{className:"tvs-activities-title"},t||"Route Insights"),!l&&!u?a("div",{className:"tvs-text-muted"},"Loading\u2026"):null,u?a("div",{className:"tvs-text-danger"},String(u)):null,a("ul",{className:"tvs-list"},f.map((n,s)=>a("li",{key:s},n))))}function G(){document.querySelectorAll(".tvs-route-insights-block").forEach((t,e)=>{if(t.__tvsMounted)return;let o=t.getAttribute("data-title")||"",i=t.getAttribute("data-show-elevation")==="1",S=t.getAttribute("data-show-surface")==="1",c=t.getAttribute("data-show-eta")==="1",a=t.getAttribute("data-show-maps-link")==="1",w=parseInt(t.getAttribute("data-route-id")||"0",10)||0;F(L,{React:T,title:o,showElevation:i,showSurface:S,showEta:c,showMapsLink:a,routeId:w},t),t.__tvsMounted=!0})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",G):G();})();
//# sourceMappingURL=tvs-block-route-insights.js.map
